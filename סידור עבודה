interface Controller {
  name: string;
  jobType: string;
  assignedShifts: string[]; // מערך של 7 ימים
  assignedCount: number;
  maxShifts: number;
  rowIndex: number; // השורה המקורית לבדיקת X
}

function main(workbook: ExcelScript.Workbook, sheetName: string = "01.02.2026-07.02.2026") {
  let sheet = workbook.getWorksheet(sheetName);
  if (!sheet) {
    console.log("הגיליון לא נמצא.");
    return;
  }

  // 1. קריאת הנתונים הקיימים
  let usedRange = sheet.getUsedRange();
  let data = usedRange.getValues();
  let lastRow = usedRange.getRowCount();

  const COL_NAME = 1;      // עמודה B
  const COL_JOB_TYPE = 11; // עמודה L
  const START_ROW = 2;     // שורת התחלה של השמות
  const DAY_COLUMNS = [2, 3, 4, 5, 6, 7, 8]; // C עד I

  let controllers: Controller[] = [];

  // 2. איסוף בקרים
  for (let i = START_ROW; i < data.length; i++) {
    let name = data[i][COL_NAME] as string;
    if (name && name.trim() !== "") {
      controllers.push({
        name: name,
        jobType: data[i][COL_JOB_TYPE] as string || "",
        assignedShifts: ["", "", "", "", "", "", ""],
        assignedCount: 0,
        maxShifts: (data[i][COL_JOB_TYPE] as string || "").includes("מלאה") ? 5 : 3,
        rowIndex: i
      });
    }
  }

  // 3. לוגיקת שיבוץ (ממלא את המערך assignedShifts)
  DAY_COLUMNS.forEach((colIndex, dayIdx) => {
    let assignedThisDay = 0;
    for (let ctrl of controllers) {
      let originalVal = data[ctrl.rowIndex][colIndex] as string;
      
      // בדיקת אילוץ (X) ומכסה
      if (originalVal === "X" || originalVal === "x" || ctrl.assignedCount >= ctrl.maxShifts) {
        continue;
      }

      // קביעת זמן משמרת
      let time = "";
      if (dayIdx === 5) time = "06:00-14:30"; // שישי
      else if (dayIdx === 6) time = "19:30-23:30"; // מוצ"ש
      else time = (assignedThisDay % 2 === 0) ? "06:00-16:00" : "13:00-23:00"; // חול

      ctrl.assignedShifts[dayIdx] = time;
      ctrl.assignedCount++;
      assignedThisDay++;
    }
  });

  // 4. הכנת הטבלה החדשה להדפסה
  let outputHeader = [["שם הבקר", "ראשון", "שני", "שלישי", "רביעי", "חמישי", "שישי", "מוצ\"ש"]];
  let outputRows = controllers.map(c => [c.name, ...c.assignedShifts]);

  // מציאת מיקום להדפסה (3 שורות מתחת לטבלה הקיימת)
  let startPrintRow = lastRow + 3;
  
  // כתיבת כותרת הטבלה החדשה
  let headerRange = sheet.getRangeByIndexes(startPrintRow, 1, 1, 8);
  headerRange.setValues(outputHeader);
  headerRange.getFormat().getFill().setColor("#D3D3D3"); // צבע רקע אפור לכותרת
  headerRange.getFormat().getFont().setBold(true);

  // כתיבת נתוני הבקרים
  let dataRange = sheet.getRangeByIndexes(startPrintRow + 1, 1, outputRows.length, 8);
  dataRange.setValues(outputRows);

  // הוספת גבולות (Borders) לטבלה החדשה
  dataRange.getFormat().getRangeBorder("EdgeLeft").setStyle("Continuous");
  dataRange.getFormat().getRangeBorder("EdgeRight").setStyle("Continuous");
  dataRange.getFormat().getRangeBorder("EdgeTop").setStyle("Continuous");
  dataRange.getFormat().getRangeBorder("EdgeBottom").setStyle("Continuous");
  dataRange.getFormat().getRangeBorder("InsideHorizontal").setStyle("Continuous");
  dataRange.getFormat().getRangeBorder("InsideVertical").setStyle("Continuous");

  console.log("טבלת השיבוץ נוצרה בהצלחה בשורה " + (startPrintRow + 1));
}
