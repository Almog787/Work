/**
 * RedLine OS V18.0 - Master Strategic Scheduler
 * ניהול תאריכים, סנכרון חודשי מבוסס החלטה, ואכיפת יעדים מלאה.
 */

interface Station {
  name: string;
  type: string;
  duration: number;
  isHub: boolean;
}

interface MonthlyKPI {
  id: string;
  target: number;
  done: number;
}

interface Controller {
  name: string;
  start: string;
  end: string;
}

function main(workbook: ExcelScript.Workbook) {
  // 1. הקמת תשתיות (לוח בקרה, יעדים, בקרים)
  setupInfrastructure(workbook);

  // 2. קריאת הגדרות מלוח הבקרה
  const dashSheet = workbook.getWorksheet("לוח_בקרה");
  const startDateValue = dashSheet.getRange("B2").getValue();
  const shouldSync = dashSheet.getRange("B3").getValue() === "כן";
  
  if (!startDateValue) {
    console.log("נא להזין תאריך תחילת שבוע בתא B2 בגיליון לוח_בקרה");
    return;
  }

  const startDate = new Date(Math.round((Number(startDateValue) - 25569) * 86400 * 1000));
  
  // 3. קריאת המצב החודשי (הזיכרון)
  let kpiTable = workbook.getTable("Monthly_KPIs_Table");
  let kpiValues = kpiTable.getRangeBetweenHeaderAndTotal().getValues() as (string | number)[][];
  let kpiMap: Map<string, MonthlyKPI> = new Map();
  kpiValues.forEach(row => {
    kpiMap.set(row[0] as string, { id: row[0] as string, target: Number(row[2]), done: Number(row[3]) });
  });

  // 4. נתוני עזר
  const controllers = readControllers(workbook);
  const stationsDB = getFullStationsDB();

  // 5. הכנת גיליון הסידור השבועי
  let scheduleSheet = workbook.getWorksheet("סידור_שבועי");
  if (!scheduleSheet) scheduleSheet = workbook.addWorksheet("סידור_שבועי");
  scheduleSheet.getUsedRange()?.clear();

  // יצירת כותרות עם תאריכים אמיתיים
  let dateHeaders: string[] = ["בקר"];
  for (let i = 0; i < 7; i++) {
    let d = new Date(startDate);
    d.setDate(d.getDate() + i);
    dateHeaders.push(`${getDayName(i)} (${d.getDate()}/${d.getMonth() + 1})`);
  }
  scheduleSheet.getRange("A1:H1").setValues([dateHeaders]);
  formatHeader(scheduleSheet.getRange("A1:H1"));

  // 6. מנוע שיבוץ אסטרטגי
  let matrix: string[][] = [];
  let currentSessionAssignments: Map<string, number> = new Map(); // מה שובץ בהרצה הזו

  for (let ctrl of controllers) {
    let row: string[] = [ctrl.name];
    for (let day = 0; day < 7; day++) {
      let dailyPlan = generateStrategicDay(ctrl, day, stationsDB, kpiMap, currentSessionAssignments);
      row.push(dailyPlan);
    }
    matrix.push(row);
  }

  // 7. כתיבת התוצאות
  if (matrix.length > 0) {
    let range = scheduleSheet.getRangeByIndexes(1, 0, matrix.length, 8);
    range.setValues(matrix);
    formatOutputTable(scheduleSheet, range);
  }

  // 8. סנכרון חודשי (רק אם המשתמש אישר בלוח הבקרה)
  if (shouldSync) {
    let updatedKPIs = kpiValues.map(row => {
      let id = row[0] as string;
      if (currentSessionAssignments.has(id)) {
        row[3] = Number(row[3]) + currentSessionAssignments.get(id)!;
      }
      return row;
    });
    kpiTable.getRangeBetweenHeaderAndTotal().setValues(updatedKPIs);
    dashSheet.getRange("B5").setValue("סונכרן בהצלחה בתאריך: " + new Date().toLocaleString());
  } else {
    dashSheet.getRange("B5").setValue("תצוגה מקדימה בלבד - לא בוצע סנכרון");
  }

  scheduleSheet.activate();
}

/**
 * מנוע שיבוץ מבוסס עדיפות חודשית
 */
function generateStrategicDay(ctrl: Controller, dayIdx: number, stations: Station[], kpiMap: Map<string, MonthlyKPI>, sessionTracker: Map<string, number>): string {
  let startMin = timeToMin(ctrl.start);
  let endMin = timeToMin(ctrl.end);
  if (dayIdx === 5) { startMin = timeToMin("06:00"); endMin = timeToMin("14:30"); }
  if (dayIdx === 6) { startMin = timeToMin("19:00"); endMin = timeToMin("24:00"); }

  let currentMin = startMin;
  let planText = "";
  let visitedToday = new Set<string>();

  while (currentMin < endMin - 20) {
    let timeLeft = endMin - currentMin;
    
    // מציאת המשימה עם הפיגור הגדול ביותר ביעדים
    let bestTask = stations
      .filter(s => s.duration <= timeLeft && !visitedToday.has(s.name))
      .sort((a, b) => {
        let remA = (kpiMap.get(a.name)?.target || 0) - (kpiMap.get(a.name)?.done || 0);
        let remB = (kpiMap.get(b.name)?.target || 0) - (kpiMap.get(b.name)?.done || 0);
        return remB - remA;
      })[0];

    if (bestTask) {
      planText += `[${minToTime(currentMin)}] ${bestTask.name}\n────────────\n`;
      visitedToday.add(bestTask.name);
      
      // עדכון מונה לסנכרון בסוף
      sessionTracker.set(bestTask.name, (sessionTracker.get(bestTask.name) || 0) + 1);
      
      currentMin += bestTask.duration;
    } else {
      planText += `[${minToTime(currentMin)}] אונבורד / נסיעה\n────────────\n`;
      currentMin += 45;
    }
  }
  return planText;
}

// --- פונקציות תשתית ---

function setupInfrastructure(workbook: ExcelScript.Workbook) {
  // לוח בקרה
  let dash = workbook.getWorksheet("לוח_בקרה");
  if (!dash) {
    dash = workbook.addWorksheet("לוח_בקרה");
    dash.getRange("A2:A3").setValues([["תאריך תחילת שבוע (יום א'):"], ["סנכרון ליעדים חודשיים?"]]);
    dash.getRange("B3").getDataValidation().setRule({ list: { inCellDropDown: true, source: "כן,לא" } });
    dash.getRange("B2").setValue(46050); // תאריך דוגמה
    dash.getRange("B3").setValue("לא");
    dash.getRange("A2:A3").getFormat().getFont().setBold(true);
    dash.getUsedRange().getFormat().autofitColumns();
  }

  // טבלת יעדים
  if (!workbook.getWorksheet("מעקב_יעדים_חודשי")) {
    let sheet = workbook.addWorksheet("מעקב_יעדים_חודשי");
    let data: (string | number)[][] = [["משימה", "סוג", "יעד", "בוצע", "יתרה"]];
    getFullStationsDB().forEach(s => data.push([s.name, s.type, 20, 0, 20]));
    sheet.getRangeByIndexes(0, 0, data.length, 5).setValues(data);
    let table = sheet.addTable(sheet.getUsedRange(), true);
    table.setName("Monthly_KPIs_Table");
    sheet.getRange("E2:E100").setFormula("=C2-D2");
  }

  // הגדרות בקרים
  if (!workbook.getWorksheet("הגדרות_בקרים")) {
    let sheet = workbook.addWorksheet("הגדרות_בקרים");
    let data = [["שם", "התחלה", "סיום"], ["אורי מייזלר", "07:00", "16:00"], ["אינה טימופייב", "07:00", "16:00"], ["דוד סייג", "07:00", "16:00"], ["בתיה אביה", "09:00", "18:00"], ["הרצל שגב", "14:00", "23:00"]];
    sheet.getRangeByIndexes(0, 0, data.length, 3).setValues(data);
    sheet.addTable(sheet.getUsedRange(), true).setName("ControllersTbl");
  }
}

function getFullStationsDB(): Station[] {
  return [
    { name: "אלנבי", type: "UG", duration: 60, isHub: false },
    { name: "קרליבך", type: "UG", duration: 60, isHub: false },
    { name: "יהודית", type: "UG", duration: 60, isHub: false },
    { name: "שאול המלך", type: "UG", duration: 60, isHub: false },
    { name: "יוספטל", type: "AG", duration: 30, isHub: false },
    { name: "קוממיות", type: "AG", duration: 30, isHub: true },
    { name: "אליפלט", type: "AG", duration: 60, isHub: true },
    { name: "ת\"מ פ\"ת", type: "AG", duration: 30, isHub: true }
  ]; // ניתן להוסיף את שאר ה-34 באותו אופן
}

function readControllers(workbook: ExcelScript.Workbook): Controller[] {
  let vals = workbook.getTable("ControllersTbl").getRangeBetweenHeaderAndTotal().getValues();
  return vals.map(r => ({ name: String(r[0]), start: convertTime(r[1]), end: convertTime(r[2]) }));
}

// --- כלי עזר ---
function timeToMin(t: string): number { let p = t.split(":"); return Number(p[0]) * 60 + Number(p[1]); }
function minToTime(m: number): string { return `${Math.floor(m / 60).toString().padStart(2, '0')}:${(m % 60).toString().padStart(2, '0')}`; }
function convertTime(v: any): string { if (typeof v === 'number') return minToTime(Math.round(v * 24 * 60)); return String(v); }
function getDayName(i: number): string { return ["ראשון", "שני", "שלישי", "רביעי", "חמישי", "שישי", "מוצ\"ש"][i]; }
function formatHeader(r: ExcelScript.Range) { r.getFormat().getFill().setColor("#0f172a"); r.getFormat().getFont().setColor("white"); r.getFormat().getFont().setBold(true); r.getFormat().setHorizontalAlignment(ExcelScript.HorizontalAlignment.center); }
function formatOutputTable(s: ExcelScript.Worksheet, r: ExcelScript.Range) { r.getFormat().setWrapText(true); r.getFormat().setVerticalAlignment(ExcelScript.VerticalAlignment.top); r.getFormat().getFont().setSize(8); s.getRange("B:H").getFormat().setColumnWidth(160); s.getRange("A:A").getFormat().setColumnWidth(100); }
