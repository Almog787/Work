function main(workbook: ExcelScript.Workbook) {
  // --- 1. הגדרות בסיס ---
  const controllerNames = [
    "אורי מייזלר", "אינה טימופייב", "אלתי קראו", "בוריס דולציגר", 
    "בוריס ינקין", "בתיה אביה", "גדי בן אור", "דוד סייג", 
    "הרצל שגב", "יוני יוסף", "משה אליהו", "ערן ניצן", 
    "רון טוב", "אברהם גברילביץ'", "יוני ניסן"
  ];
  const taskTypes = ["בקרת בטיחות", "בקרת כרטוס", "בקרת תפעול", "בקרת תחזוקה"];
  const days = ["ראשון", "שני", "שלישי", "רביעי", "חמישי", "שישי", "מוצ\"ש"];

  // --- 2. הקמת תשתית (יוצר רק אם חסר) ---
  
  // הגדרת סוג הנתונים במקום any
  type ExcelValue = string | number | boolean;

  // הכנת נתוני בקרים
  let initialControllers: ExcelValue[][] = controllerNames.map(n => [n, "משרה מלאה", 160, 0, 160]);
  setupSheetAndTable(workbook, "בקרים", "ControllersTable", ["שם הבקר", "סוג משרה", "מכסה חודשית", "בוצע", "יתרה"], initialControllers);
  
  // יצירת 34 תחנות X 4 משימות בסימולציה
  let initialTasks: ExcelValue[][] = [];
  for (let i = 1; i <= 34; i++) {
    taskTypes.forEach(t => initialTasks.push([`תחנה ${i}`, t, 10, 0, "רגילה"]));
  }
  setupSheetAndTable(workbook, "מכסות_משימות", "TasksTable", ["תחנה", "סוג משימה", "יעד חודשי", "בוצע", "עדיפות"], initialTasks);

  // יצירת אילוצים
  let initialConstraints: ExcelValue[][] = controllerNames.map(n => [n, "", "", "", "", "", "", ""]);
  setupSheetAndTable(workbook, "אילוצים_שבועיים", "ConstraintsTable", ["שם הבקר", ...days], initialConstraints);

  // הכנת גיליון פלט
  let finalSheet = workbook.getWorksheet("לוח_שיבוץ_סופי") || workbook.addWorksheet("לוח_שיבוץ_סופי");
  finalSheet.getUsedRange()?.clear();
  finalSheet.getRange("A1:F1").setValues([["יום", "שם הבקר", "משעה", "עד שעה", "משימה", "הערות"]]);

  // --- 3. מנוע השיבוץ ---
  
  let constraintsTable = workbook.getTable("ConstraintsTable");
  let constraintsData = constraintsTable.getRange().getValues();
  
  let tasksTable = workbook.getTable("TasksTable");
  let tasksData = tasksTable.getRange().getValues();

  // יצירת רשימת משימות ממוינת (ללא any)
  let taskList = tasksData.slice(1).map((row) => {
    return {
      station: row[0] as string,
      task: row[1] as string,
      done: Number(row[3])
    };
  }).sort((a, b) => a.done - b.done);

  let scheduleRows: ExcelValue[][] = [];
  let taskPtr = 0;

  days.forEach((dayName, dIdx) => {
    let dailyAssignedCount = 0;

    let startTime = "06:00:00", endTime = "16:00:00", isLongShift = true;
    if (dIdx === 5) { startTime = "06:00:00"; endTime = "14:30:00"; isLongShift = false; }
    if (dIdx === 6) { startTime = "19:30:00"; endTime = "00:30:00"; isLongShift = false; }

    for (let i = 1; i < constraintsData.length; i++) {
      let bokerName = constraintsData[i][0] as string;
      let availability = constraintsData[i][dIdx + 1] as string;

      if (availability.toUpperCase() !== "X" && dailyAssignedCount < 6) {
        let currentTask = taskList[taskPtr % taskList.length];
        
        scheduleRows.push([
          dayName,
          bokerName,
          startTime,
          endTime,
          `${currentTask.station} (${currentTask.task})`,
          isLongShift ? "חריגה מעל 9 שעות" : ""
        ]);

        dailyAssignedCount++;
        taskPtr++;
      }
    }
  });

  // --- 4. כתיבת התוצאות ---
  if (scheduleRows.length > 0) {
    finalSheet.getRangeByIndexes(1, 0, scheduleRows.length, 6).setValues(scheduleRows);
    
    // עיצוב וטבלה
    let tableRange = finalSheet.getRangeByIndexes(0, 0, scheduleRows.length + 1, 6);
    if (!workbook.getTable("FinalScheduleTable")) {
        workbook.addTable(tableRange, true).setName("FinalScheduleTable");
    }
  }

  finalSheet.getUsedRange().getFormat().autofitColumns();
  finalSheet.activate();
  
  console.log("הסידור הושלם בהצלחה.");
}

/**
 * פונקציית עזר להקמת גיליונות וטבלאות ללא שימוש ב-any
 */
function setupSheetAndTable(
    workbook: ExcelScript.Workbook, 
    sheetName: string, 
    tableName: string, 
    headers: string[], 
    defaultData: (string | number | boolean)[][]
) {
  let sheet = workbook.getWorksheet(sheetName);
  
  if (!sheet) {
    sheet = workbook.addWorksheet(sheetName);
    let headerRange = sheet.getRangeByIndexes(0, 0, 1, headers.length);
    headerRange.setValues([headers]);
    
    sheet.getRangeByIndexes(1, 0, defaultData.length, headers.length).setValues(defaultData);
    
    let tableRange = sheet.getRangeByIndexes(0, 0, defaultData.length + 1, headers.length);
    let table = workbook.addTable(tableRange, true);
    table.setName(tableName);
    
    headerRange.getFormat().getFill().setColor("#4472C4");
    headerRange.getFormat().getFont().setColor("white");
    sheet.getUsedRange().getFormat().autofitColumns();
  }
}
