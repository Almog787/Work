/**
 * מערכת סידור עבודה אסטרטגי - רכבת קלה (V8.1 Fixed)
 * תוקן עבור תאימות מלאה ל-Strict Mode של Office Scripts
 */

// הגדרת טיפוסים למבני הנתונים
interface TaskDef {
  name: string;
  duration: number;
  type: string;
  category: string;
}

interface ControllerDef {
  name: string;
  start: string;
  end: string;
}

function main(workbook: ExcelScript.Workbook) {
  // 1. הקמת תשתיות (אם לא קיימות)
  // הסרנו את await כי הפעולות הן סינכרוניות
  ensureSetupSheet(workbook, "הגדרות_משימות", getTaskDefaults());
  ensureSetupSheet(workbook, "הגדרות_בקרים", getControllerDefaults());
  ensureSetupSheet(workbook, "הגדרות_תחנות", getStationDefaults());

  // 2. קריאת הנתונים העדכניים מהטבלאות
  const taskDefs = readTasksFromTable(workbook, "הגדרות_משימות");
  const controllers = readControllersFromTable(workbook, "הגדרות_בקרים");
  const stationList = readStationsFromTable(workbook, "הגדרות_תחנות");

  // 3. הכנת גיליון הפלט
  let outputSheet = workbook.getWorksheet("סידור_שבועי");
  if (!outputSheet) {
    outputSheet = workbook.addWorksheet("סידור_שבועי");
  }
  
  // ניקוי הגיליון בזהירות
  let usedRange = outputSheet.getUsedRange();
  if (usedRange) {
    usedRange.clear();
  }

  // כותרות הטבלה
  const headers = [["שם הבקר", "ראשון", "שני", "שלישי", "רביעי", "חמישי", "שישי", "מוצ\"ש"]];
  const headerRange = outputSheet.getRange("A1:H1");
  headerRange.setValues(headers);
  headerRange.getFormat().getFill().setColor("#1e293b"); // כחול כהה
  headerRange.getFormat().getFont().setColor("white");
  headerRange.getFormat().getFont().setBold(true);

  // 4. לוגיקת השיבוץ
  let scheduleMatrix: string[][] = [];

  // מעבר על כל בקר (שורות)
  for (let ctrl of controllers) {
    let row: string[] = [ctrl.name];

    // מעבר על כל יום (עמודות)
    for (let day = 0; day < 7; day++) {
      let dayContent = generateDaySchedule(ctrl, day, taskDefs, stationList);
      row.push(dayContent);
    }
    scheduleMatrix.push(row);
  }

  // 5. כתיבת התוצאות
  if (scheduleMatrix.length > 0) {
    // כתיבת הנתונים
    let range = outputSheet.getRangeByIndexes(1, 0, scheduleMatrix.length, 8);
    range.setValues(scheduleMatrix);
    
    // עיצוב התאים
    range.getFormat().setWrapText(true);
    range.getFormat().setVerticalAlignment(ExcelScript.VerticalAlignment.top);
    
    // רוחב עמודות
    outputSheet.getRange("B:H").getFormat().setColumnWidth(180);
    outputSheet.getRange("A:A").getFormat().setColumnWidth(100);
    
    // הוספת גבולות - שימוש ב-Enum רשמי כדי למנוע שגיאות
    let borderFormat = range.getFormat();
    
    let insideHorizontal = borderFormat.getRangeBorder(ExcelScript.BorderIndex.insideHorizontal);
    insideHorizontal.setStyle(ExcelScript.BorderLineStyle.continuous);
    
    let insideVertical = borderFormat.getRangeBorder(ExcelScript.BorderIndex.insideVertical);
    insideVertical.setStyle(ExcelScript.BorderLineStyle.continuous);
    
    let edgeBottom = borderFormat.getRangeBorder(ExcelScript.BorderIndex.edgeBottom);
    edgeBottom.setStyle(ExcelScript.BorderLineStyle.continuous);
  }

  console.log("הסידור נוצר בהצלחה!");
}

/**
 * מנוע יצירת הלו"ז ליום בודד
 */
function generateDaySchedule(ctrl: ControllerDef, dayIdx: number, tasks: TaskDef[], stations: string[]): string {
  // התאמת שעות לפי חוקי סופ"ש
  let startStr = ctrl.start;
  let endStr = ctrl.end;
  
  if (dayIdx === 5) { startStr = "06:00"; endStr = "14:30"; } // שישי
  if (dayIdx === 6) { startStr = "19:00"; endStr = "24:00"; } // מוצ"ש

  let currentMin = timeToMin(startStr);
  let endMin = timeToMin(endStr);
  
  let scheduleText = "";
  
  // יצירת מאגר משימות זמין ליום הזה
  // המרת הנתונים למערך חדש כדי לא לפגוע במקורי
  let availableTasks: TaskDef[] = [];
  tasks.forEach(t => availableTasks.push(t));
  
  // ערבוב אקראי ידני (כי אין sort random מובנה בטיפוסים מסוימים)
  availableTasks.sort(() => Math.random() - 0.5);
  
  while (currentMin < endMin - 15) {
    const timeLeft = endMin - currentMin;
    
    let selectedTask: TaskDef | undefined = undefined;
    
    // לוגיקת בחירה
    for (let t of availableTasks) {
      if (t.duration <= timeLeft) {
        selectedTask = t;
        break;
      }
    }

    if (!selectedTask) break; // אין משימות מתאימות לזמן שנותר

    // יצירת פרטים
    let detail = "";
    if (selectedTask.category === "STATION") {
      detail = stations[Math.floor(Math.random() * stations.length)];
    } else if (selectedTask.category === "TRACK") {
      detail = "מקטע " + Math.floor(Math.random() * 21);
    }

    // הוספה לטקסט
    let startTime = minToTime(currentMin);
    currentMin += selectedTask.duration;

    scheduleText += `${startTime} ${selectedTask.name} ${detail}\n`;
  }

  return scheduleText;
}

// --- פונקציות עזר להקמת גיליונות ---

function ensureSetupSheet(workbook: ExcelScript.Workbook, sheetName: string, defaultData: (string | number)[][]) {
  let sheet = workbook.getWorksheet(sheetName);
  
  if (!sheet) {
    sheet = workbook.addWorksheet(sheetName);
    
    // כתיבת נתונים
    let range = sheet.getRangeByIndexes(0, 0, defaultData.length, defaultData[0].length);
    range.setValues(defaultData);
    
    // יצירת טבלה
    let table = workbook.addTable(range, true);
    table.setName(sheetName + "_Table");
    
    // עיצוב כותרת
    let headerRange = sheet.getRangeByIndexes(0, 0, 1, defaultData[0].length);
    headerRange.getFormat().getFill().setColor("#4472C4");
    headerRange.getFormat().getFont().setColor("white");
    sheet.getUsedRange().getFormat().autofitColumns();

    // הוספת ולידציה לגיליון משימות
    if (sheetName === "הגדרות_משימות") {
      let catRange = sheet.getRange("C2:C100");
      let dataValidation = catRange.getDataValidation();
      dataValidation.setRule({
        list: {
          inCellDropDown: true,
          source: "STATION,TRACK,ONBOARD,KARON,SERVICE"
        }
      });
    }
  }
}

// --- פונקציות המרת זמן ---
function timeToMin(t: string): number {
  if (!t) return 0;
  // וידוא שהטקסט בפורמט תקין, אחרת החזרת 0
  if (t.indexOf(":") === -1) return 0;
  
  let parts = t.split(":");
  return parseInt(parts[0]) * 60 + parseInt(parts[1]);
}

function minToTime(mins: number): string {
  let h = Math.floor(mins / 60);
  let m = mins % 60;
  return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
}

// --- קריאת נתונים מהטבלאות ---
function readTasksFromTable(workbook: ExcelScript.Workbook, sheetName: string): TaskDef[] {
  let table = workbook.getTable(sheetName + "_Table");
  if (!table) return getTaskDefaultsObj(); 
  
  let range = table.getRangeBetweenHeaderAndTotal();
  // שימוש בטיפוס מפורש כדי למנוע שגיאות
  let values: (string | number | boolean)[][] = range.getValues();
  
  let tasks: TaskDef[] = [];
  for (let row of values) {
    tasks.push({
      name: row[0] as string,
      duration: Number(row[1]),
      type: row[2] as string,
      category: row[2] as string
    });
  }
  return tasks;
}

function readControllersFromTable(workbook: ExcelScript.Workbook, sheetName: string): ControllerDef[] {
  let table = workbook.getTable(sheetName + "_Table");
  if (!table) return []; 
  
  let values: (string | number | boolean)[][] = table.getRangeBetweenHeaderAndTotal().getValues();
  let controllers: ControllerDef[] = [];

  for (let row of values) {
      controllers.push({
        name: row[0] as string,
        start: convertExcelTime(row[1]),
        end: convertExcelTime(row[2])
      });
  }
  return controllers;
}

function readStationsFromTable(workbook: ExcelScript.Workbook, sheetName: string): string[] {
  let table = workbook.getTable(sheetName + "_Table");
  if (!table) return [];
  
  let values: (string | number | boolean)[][] = table.getRangeBetweenHeaderAndTotal().getValues();
  let stations: string[] = [];
  for (let row of values) {
      stations.push(row[0] as string);
  }
  return stations;
}

// המרת זמן אקסל ללא שימוש ב-Any
function convertExcelTime(val: string | number | boolean): string {
  if (typeof val === 'string') return val;
  if (typeof val === 'number') {
    // זמן באקסל הוא שבר של יממה (0.5 = 12:00)
    let totalMins = Math.round(val * 24 * 60);
    return minToTime(totalMins);
  }
  return "00:00";
}

// --- נתוני ברירת מחדל ---

function getTaskDefaults(): (string | number)[][] {
  return [
    ["שם המשימה", "משך (דקות)", "קטגוריה"],
    ["בקרת תחנה תת\"ק", 60, "STATION"],
    ["בקרת תחנה עילית", 30, "STATION"],
    ["בקרת תחנה (בלינסון)", 45, "STATION"],
    ["בקרת קרונות", 65, "KARON"],
    ["אונבורד R1", 80, "ONBOARD"],
    ["אונבורד R3", 45, "ONBOARD"],
    ["ניקיון מסילה", 30, "TRACK"],
    ["בקרת מסלול", 80, "TRACK"],
    ["מרכז שירות", 15, "SERVICE"],
    ["מוקד", 15, "SERVICE"]
  ];
}

function getTaskDefaultsObj(): TaskDef[] {
    return [
        { name: "תחנה תת\"ק", duration: 60, type: "STATION", category: "STATION" },
        { name: "תחנה עילית", duration: 30, type: "STATION", category: "STATION" },
        { name: "קרונות", duration: 65, type: "KARON", category: "KARON" },
        { name: "אונבורד", duration: 60, type: "ONBOARD", category: "ONBOARD" }
    ];
}

function getControllerDefaults(): (string | number)[][] {
  return [
    ["שם הבקר", "התחלה", "סיום"],
    ["אורי מייזלר", "07:00", "16:00"],
    ["אינה טימופייב", "07:00", "16:00"],
    ["אלתי קראו", "08:00", "17:00"],
    ["בוריס דולציגר", "06:00", "15:00"],
    ["בתיה אביה", "09:00", "18:00"],
    ["דוד סייג", "07:00", "16:00"],
    ["הרצל שגב", "14:00", "23:00"],
    ["יוני יוסף", "14:00", "23:00"],
    ["משה אליהו", "15:00", "23:00"],
    ["ערן ניצן", "06:00", "15:00"],
    ["רון טוב", "07:00", "16:00"],
    ["אברהם גברילביץ'", "08:00", "17:00"]
  ];
}

function getStationDefaults(): (string | number)[][] {
  return [
    ["שם התחנה", "סוג"],
    ["אלנבי", "UG"], ["קרליבך", "UG"], ["יהודית", "UG"], ["שאול המלך", "UG"], ["ארלוזורוב", "UG"],
    ["הקוממיות", "AG"], ["העמל", "AG"], ["כ\"ט בנובמבר", "AG"], ["יוספטל", "AG"], ["בלפור", "AG"],
    ["בלינסון", "AG"], ["ת\"מ פ\"ת", "AG"], ["קרית אריה", "AG"]
  ];
}
