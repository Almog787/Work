/**
 * RedLine Master Scheduler V16.0
 * ×›×•×œ×œ: ×—×œ×•× ×•×ª ×–××Ÿ ×“×™× ××™×™×, ×¨×¦×£ ×’××•×’×¨×¤×™, ×‘×œ×•×§×™× ×©×œ ×§×¨×•× ×•×ª ×•××›×™×¤×ª ×—×•×§×™× ××œ××”.
 */

// --- ×××©×§×™× (Interfaces) ---

interface Station {
  id: number;
  name: string;
  type: string; // AG / UG
  duration: number; // ×–××Ÿ ×‘×§×¨×” ×›×•×œ×œ
  nextStation: string; // ×œ×ª×›× ×•×Ÿ ×’××•×’×¨×¤×™
  prevStation: string;
}

interface TimeWindow {
  station: string;
  dayIdx: number; // 0=Sun, 6=Sat
  startMin: number;
  endMin: number;
}

interface Controller {
  name: string;
  start: string;
  end: string;
}

interface TaskBlock {
  text: string;
  duration: number;
}

// ××¢×§×‘ ×™×•××™ ×’×œ×•×‘×œ×™
interface DailyTracker {
  visitedStations: Set<string>; // ×ª×—× ×•×ª ×©×‘×•×¦×¢×• ×”×™×•×
  hubKaronCounts: Map<string, number>; // ×›××” ×§×¨×•× ×•×ª ×‘×•×¦×¢×• ×‘×›×œ ×”××‘
}

function main(workbook: ExcelScript.Workbook) {
  // 1. ×”×§××ª ×ª×©×ª×™×•×ª × ×ª×•× ×™× (×× ×œ× ×§×™×™××•×ª)
  setupReferenceTables(workbook);
  
  // 2. ×§×¨×™××ª × ×ª×•× ×™×
  const controllers: Controller[] = readControllers(workbook);
  const stationsDB: Station[] = getStationsDB();
  const timeWindows: TimeWindow[] = readTimeWindows(workbook); // ×§×¨×™××ª ×”×˜×‘×œ×” ×”×’×“×•×œ×”

  // 3. ×”×›× ×ª ×’×™×œ×™×•×Ÿ ×¤×œ×˜
  let outputSheet = workbook.getWorksheet("×¡×™×“×•×¨_×¡×•×¤×™");
  if (!outputSheet) outputSheet = workbook.addWorksheet("×¡×™×“×•×¨_×¡×•×¤×™");
  
  let usedRange = outputSheet.getUsedRange();
  if (usedRange) usedRange.clear();

  const daysHeader = ["×¨××©×•×Ÿ", "×©× ×™", "×©×œ×™×©×™", "×¨×‘×™×¢×™", "×—××™×©×™", "×©×™×©×™", "××•×¦\"×©"];
  outputSheet.getRange("A1:H1").setValues([["×‘×§×¨", ...daysHeader]]);
  formatHeader(outputSheet.getRange("A1:H1"));

  // 4. ×œ×•×’×™×§×ª ×©×™×‘×•×¥ ×¨××©×™×ª
  let matrix: string[][] = [];
  
  // ××ª×—×•×œ ×˜×¨××§×¨×™× ×œ×›×œ ×™×•× ×‘×©×‘×•×¢
  let weeklyTrackers: DailyTracker[] = [];
  for(let i=0; i<7; i++) {
      weeklyTrackers.push({ 
          visitedStations: new Set<string>(),
          hubKaronCounts: new Map<string, number>()
      });
  }

  // ××™×•×Ÿ ×‘×§×¨×™× ×œ×¤×™ ×©×¢×ª ×”×ª×—×œ×” (×”×§×“×•××™× ××§×‘×œ×™× ×¢×“×™×¤×•×ª ×œ××©×™××•×ª ×‘×•×§×¨)
  controllers.sort((a,b) => timeToMin(a.start) - timeToMin(b.start));

  for (let ctrl of controllers) {
    let row: string[] = [ctrl.name];

    for (let dIdx = 0; dIdx < 7; dIdx++) {
      let plan = generateDaySchedule(ctrl, dIdx, stationsDB, timeWindows, weeklyTrackers[dIdx]);
      row.push(plan);
    }
    matrix.push(row);
  }

  // 5. ×›×ª×™×‘×”
  if (matrix.length > 0) {
    let range = outputSheet.getRangeByIndexes(1, 0, matrix.length, 8);
    range.setValues(matrix);
    formatOutputTable(outputSheet, range);
  }

  console.log("×”×¡×™×“×•×¨ ×”×•×©×œ× ×‘×”×¦×œ×—×” ×¢× ×›×œ ×”××™×œ×•×¦×™×.");
}

/**
 * ×× ×•×¢ ×”×©×™×‘×•×¥ ×”×™×•××™ - ×”××•×— ×©×œ ×”××¢×¨×›×ª
 */
function generateDaySchedule(ctrl: Controller, dayIdx: number, stations: Station[], windows: TimeWindow[], tracker: DailyTracker): string {
  // ×”×ª×××ª ×©×¢×•×ª
  let startStr = ctrl.start;
  let endStr = ctrl.end;
  if (dayIdx === 5) { startStr = "06:00"; endStr = "14:30"; }
  if (dayIdx === 6) { startStr = "19:00"; endStr = "24:00"; }

  let currentMin = timeToMin(startStr);
  let endMin = timeToMin(endStr);
  let outputText = "";
  
  // ××™×§×•× × ×•×›×—×™ ×©×œ ×”×‘×§×¨ (×œ×¦×•×¨×š ×¨×¦×£ ×’××•×’×¨×¤×™)
  // ××ª×—×™×œ×™× ×‘×‘×¨×™×¨×ª ××—×“×œ ××• ××§×¨××™
  let currentLocation: string = "×ª\"× ×¤\"×ª"; 
  let karonDoneTodayForController = false; // ×”×× ×”×‘×§×¨ ×”×–×” ×›×‘×¨ ×¢×©×” ×§×¨×•× ×•×ª ×”×™×•×?

  while (currentMin < endMin - 15) {
    const timeLeft = endMin - currentMin;
    let selectedTask: TaskBlock | null = null;

    // --- ×¢×“×™×¤×•×ª 1: ×‘×§×¨×ª ×§×¨×•× ×•×ª (×—×•×‘×” ×©×¢×ª×™×™× ×‘×•×§×¨/×¢×¨×‘) ---
    // ×× ×”×‘×§×¨ ×˜×¨× ×‘×™×¦×¢ ×§×¨×•× ×•×ª, ×•×™×© ×œ×• ××¡×¤×™×§ ×–××Ÿ (×œ×¤×—×•×ª 130 ×“×§' ×œ×¦××“ ××©×™××•×ª)
    if (!karonDoneTodayForController && timeLeft >= 130) {
        // ×‘×“×™×§×ª ×©×¢×•×ª ××©××¨×ª ×‘×•×§×¨/×¢×¨×‘ ×œ×¤×™ ×”×“×¨×™×©×”
        const isMorningWindow = currentMin >= 360 && currentMin <= 840; // 06-14
        const isEveningWindow = currentMin >= 840 && currentMin <= 1320; // 14-22
        
        if (isMorningWindow || isEveningWindow) {
            // ×‘×—×™×¨×ª ×”××‘ ×”×§×¨×•×‘ ×‘×™×•×ª×¨ ××• ××§×¨××™
            const hubs = ["××œ×™×¤×œ×˜", "×§×¨×™×™×ª ××¨×™×”", "×ª\"× ×¤\"×ª", "×”×§×•×××™×•×ª"];
            const hub = hubs[Math.floor(Math.random() * hubs.length)];
            
            // ×©×™×‘×•×¥ ×¦××“ ××©×™××•×ª (×‘×œ×•×§ ××—×“ ×‘×˜×§×¡×˜)
            selectedTask = {
                text: `âš™ï¸ ×§×¨×•× ×•×ª ×›×¤×•×œ (${hub}) - ×©×¢×ª×™×™×`,
                duration: 130 // 65 * 2
            };
            karonDoneTodayForController = true;
            currentLocation = hub;
        }
    }

    // --- ×¢×“×™×¤×•×ª 2: ×—×œ×•× ×•×ª ×–××Ÿ ×“×™× ××™×™× ×œ×ª×—× ×•×ª ---
    if (!selectedTask) {
        // ×—×¤×© ×ª×—× ×” ×©×—×œ×•×Ÿ ×”×–××Ÿ ×©×œ×” ×”×•× *×¢×›×©×™×•* ×•×˜×¨× ×‘×•×¦×¢×”
        // ×•×’×: × ×¡×” ×œ××¦×•× ×ª×—× ×” ×©×§×¨×•×‘×” ×œ××™×§×•× ×”× ×•×›×—×™ (currentLocation)
        
        // ×¡×™× ×•×Ÿ ×›×œ ×”×—×œ×•× ×•×ª ×”×¨×œ×•×•× ×˜×™×™× ×œ×¢×›×©×™×• ×•×œ×™×•× ×”×–×”
        const validWindows = windows.filter(w => 
            w.dayIdx === dayIdx && 
            currentMin >= w.startMin && 
            currentMin + 30 <= w.endMin && // ×©×™×”×™×” ×–××Ÿ ×œ×‘×¦×¢
            !tracker.visitedStations.has(w.station)
        );

        if (validWindows.length > 0) {
            // ×‘×—×™×¨×ª ×”×ª×—× ×” ×”××ª××™××” ×‘×™×•×ª×¨
            // × ×¡×™×•×Ÿ ×œ××¦×•× ×§×™×¨×‘×” ×’××•×’×¨×¤×™×ª
            let bestMatch = validWindows.find(w => isNearby(currentLocation, w.station, stations));
            
            // ×× ××™×Ÿ ×§×¨×•×‘×”, ×§×— ××ª ×”×¨××©×•× ×” ×©×–××™× ×”
            if (!bestMatch) bestMatch = validWindows[0];

            // ××¦×™××ª ×¤×¨×˜×™ ×”×ª×—× ×” ×”××œ××™×
            const stationData = stations.find(s => s.name === bestMatch.station);
            
            if (stationData) {
                selectedTask = {
                    text: `ğŸš‰ ${stationData.name} (${stationData.type})`,
                    duration: stationData.duration
                };
                tracker.visitedStations.add(stationData.name);
                currentLocation = stationData.name;
            }
        }
    }

    // --- ×¢×“×™×¤×•×ª 3: ××™×œ×•×™ ×–××Ÿ (××¡×™×œ×•×ª / ××•× ×‘×•×¨×“ / ×©×™×¨×•×ª) ---
    if (!selectedTask) {
        // ×× ×× ×—× ×• ×œ×™×“ ×”×§×¦×” - ××•× ×‘×•×¨×“ ××¨×•×š
        if ((currentLocation === "×ª\"× ×¤\"×ª" || currentLocation === "×”×§×•×××™×•×ª") && timeLeft >= 80) {
            selectedTask = { text: "ğŸš† ××•× ×‘×•×¨×“ R1 ××œ×", duration: 80 };
            currentLocation = (currentLocation === "×ª\"× ×¤\"×ª") ? "×”×§×•×××™×•×ª" : "×ª\"× ×¤\"×ª";
        } 
        // ××•× ×‘×•×¨×“ ×§×¦×¨
        else if (timeLeft >= 45) {
            selectedTask = { text: "ğŸš† ××•× ×‘×•×¨×“ R3 / ×—×œ×§×™", duration: 45 };
            // ×¢×“×›×•×Ÿ ××™×§×•× ×•×™×¨×˜×•××œ×™ (×”×ª×§×“××•×ª ×¢×œ ×”×§×•)
            currentLocation = moveVirtualLocation(currentLocation, stations);
        }
        // × ×™×§×™×•×Ÿ ××¡×™×œ×•×ª
        else if (timeLeft >= 30) {
            selectedTask = { text: "ğŸ›¤ï¸ × ×™×§×™×•×Ÿ ××¡×™×œ×” (××§×˜×¢)", duration: 30 };
        }
        // ×©×™×¨×•×ª
        else if (timeLeft >= 15) {
            selectedTask = { text: "ğŸ“ ××•×§×“ ×©×™×¨×•×ª", duration: 15 };
        }
    }

    if (!selectedTask) break; // ××™×Ÿ ×™×•×ª×¨ ××©×™××•×ª ××ª××™××•×ª

    // ×”×•×¡×¤×” ×œ×¤×œ×˜
    outputText += `[${minToTime(currentMin)}] ${selectedTask.text}\n`;
    outputText += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
    
    currentMin += selectedTask.duration;
}

  return outputText;
}

// --- ×œ×•×’×™×§×” ×’××•×’×¨×¤×™×ª ×‘×¡×™×¡×™×ª ---

function isNearby(current: string, target: string, stations: Station[]): boolean {
    // ×‘×“×™×§×” ×¤×©×•×˜×”: ×”×× ×”×™×¢×“ ×”×•× ×”×ª×—× ×” ×”×‘××” ××• ×”×§×•×“××ª
    // (×‘××¢×¨×›×ª ××œ××” ×”×™×™× ×• ××©×ª××©×™× ×‘××™× ×“×§×¡×™×)
    const currIdx = stations.findIndex(s => s.name === current);
    const targetIdx = stations.findIndex(s => s.name === target);
    if (currIdx === -1 || targetIdx === -1) return false;
    
    return Math.abs(currIdx - targetIdx) <= 5; // ×˜×•×•×— ×©×œ 5 ×ª×—× ×•×ª × ×—×©×‘ "×§×¨×•×‘"
}

function moveVirtualLocation(current: string, stations: Station[]): string {
    const idx = stations.findIndex(s => s.name === current);
    if (idx === -1) return "×ª\"× ×¤\"×ª";
    // ××“××” × ×¡×™×¢×” ×©×œ 5-10 ×ª×—× ×•×ª
    let newIdx = idx + 5;
    if (newIdx >= stations.length) newIdx = idx - 5;
    if (newIdx < 0) newIdx = 0;
    return stations[newIdx].name;
}

// --- ×”×§××ª × ×ª×•× ×™× (Setup) ---

function setupReferenceTables(workbook: ExcelScript.Workbook) {
    // 1. ×’×™×œ×™×•×Ÿ ×‘×§×¨×™×
    if (!workbook.getWorksheet("×”×’×“×¨×•×ª_×‘×§×¨×™×")) {
        let sheet = workbook.addWorksheet("×”×’×“×¨×•×ª_×‘×§×¨×™×");
        let data = [
            ["×©×", "×”×ª×—×œ×”", "×¡×™×•×"],
            ["××•×¨×™ ××™×™×–×œ×¨", "07:00", "16:00"], ["××™× ×” ×˜×™××•×¤×™×™×‘", "07:00", "16:00"],
            ["××œ×ª×™ ×§×¨××•", "08:00", "17:00"], ["×‘×•×¨×™×¡ ×“×•×œ×¦×™×’×¨", "06:00", "15:00"],
            ["×‘×ª×™×” ××‘×™×”", "09:00", "18:00"], ["×“×•×“ ×¡×™×™×’", "07:00", "16:00"],
            ["×”×¨×¦×œ ×©×’×‘", "14:00", "23:00"], ["×™×•× ×™ ×™×•×¡×£", "14:00", "23:00"],
            ["×¢×¨×Ÿ × ×™×¦×Ÿ", "06:00", "15:00"], ["×¨×•×Ÿ ×˜×•×‘", "07:00", "16:00"],
            ["××‘×¨×”× ×’×‘×¨×™×œ×‘×™×¥'", "08:00", "17:00"], ["×’×“×™ ×‘×Ÿ ××•×¨", "10:00", "19:00"],
            ["×™×•× ×™ × ×™×¡×Ÿ", "12:00", "21:00"], ["××©×” ××œ×™×”×•", "15:00", "23:00"]
        ];
        sheet.getRangeByIndexes(0,0,data.length,3).setValues(data);
        sheet.addTable(sheet.getUsedRange(), true).setName("ControllersTbl");
    }

    // 2. ×’×™×œ×™×•×Ÿ ×—×œ×•× ×•×ª ×–××Ÿ ×“×™× ××™×™× (×”×˜×‘×œ×” ×”×’×“×•×œ×”)
    if (!workbook.getWorksheet("×—×œ×•× ×•×ª_×–××Ÿ_×“×™× ××™×™×")) {
        let sheet = workbook.addWorksheet("×—×œ×•× ×•×ª_×–××Ÿ_×“×™× ××™×™×");
        
        // ×›×•×ª×¨×•×ª
        let headers = ["×©× ×ª×—× ×”", "×¡×•×’", "×¨××©×•×Ÿ_×”×ª×—×œ×”", "×¨××©×•×Ÿ_×¡×™×•×", "×©× ×™_×”×ª×—×œ×”", "×©× ×™_×¡×™×•×", "×©×œ×™×©×™_×”×ª×—×œ×”", "×©×œ×™×©×™_×¡×™×•×", "×¨×‘×™×¢×™_×”×ª×—×œ×”", "×¨×‘×™×¢×™_×¡×™×•×", "×—××™×©×™_×”×ª×—×œ×”", "×—××™×©×™_×¡×™×•×", "×©×™×©×™_×”×ª×—×œ×”", "×©×™×©×™_×¡×™×•×"];
        
        // ×™×¦×™×¨×ª ×”× ×ª×•× ×™× ××”×˜×‘×œ×” ×©×¡×™×¤×§×ª (×“×•×’××” ×—×œ×§×™×ª ×œ×™×™×©×•× ××•×˜×•××˜×™, × ×™×ª×Ÿ ×œ×”×¨×—×™×‘ ×œ×›×œ ×”-34)
        // ×©×™× ×œ×‘: ×–×” ××™×™×¦×¨ ××ª ×”××‘× ×”, ×”×¡×§×¨×™×¤×˜ ×™×•×“×¢ ×œ×§×¨×•× ××ª ×–×”
        let data: (string|number)[][] = [];
        const stationsAG = ["×”×§×•×××™×•×ª", "×”×¢××œ", "×›\"×˜ ×‘× ×•×‘××‘×¨", "×™×•×¡×¤×˜×œ", "×‘× ×™××™×Ÿ", "×‘×œ×¤×•×¨", "×–'×‘×•×˜×™× ×¡×§×™", "×¨×•×˜×©×™×œ×“", "×”×¢×¦×××•×ª", "××—×¨×•×–×ª"];
        
        // ×œ×•×’×™×§×ª ×”×¡×˜×” (Staggering) ×›××• ×‘×˜×‘×œ×” ×©×œ×š
        stationsAG.forEach((s, i) => {
            // ×™×¦×™×¨×ª ×“×¤×•×¡ ××“×•×¨×’
            let startH = 5 + Math.floor(i/3); 
            data.push([s, "AG", 
                `${startH}:40`, `${startH+2}:00`, // ×¨××©×•×Ÿ
                `${startH+2}:00`, `${startH+4}:30`, // ×©× ×™
                `${startH+4}:30`, `${startH+7}:00`, // ×©×œ×™×©×™
                "13:00", "15:30", // ×•×›×Ÿ ×”×œ××”... ×‘×¨×™×¨×ª ××—×“×œ
                "15:30", "18:00",
                "18:00", "20:30"
            ]);
        });

        // ×”×•×¡×¤×ª ×”× ×ª×•× ×™× ×œ×’×™×œ×™×•×Ÿ
        if(data.length > 0) {
            sheet.getRangeByIndexes(0, 0, 1, headers.length).setValues([headers]);
            sheet.getRangeByIndexes(1, 0, data.length, headers.length).setValues(data);
            sheet.addTable(sheet.getUsedRange(), true).setName("TimeWindowsTbl");
        }
    }
}

// --- ×§×¨×™××ª × ×ª×•× ×™× ---

function readControllers(workbook: ExcelScript.Workbook): Controller[] {
    let table = workbook.getTable("ControllersTbl");
    if(!table) return [];
    let vals = table.getRangeBetweenHeaderAndTotal().getValues() as (string|number|boolean)[][];
    return vals.map(r => ({ name: String(r[0]), start: convertTime(r[1]), end: convertTime(r[2]) }));
}

function readTimeWindows(workbook: ExcelScript.Workbook): TimeWindow[] {
    let table = workbook.getTable("TimeWindowsTbl");
    if(!table) return []; // ××—×–×™×¨ ×¨×™×§ ×× ××™×Ÿ × ×ª×•× ×™×, ×”×©×™×‘×•×¥ ×™×ª×‘×¡×¡ ×¢×œ ××§×¨××™×•×ª
    
    let vals = table.getRangeBetweenHeaderAndTotal().getValues() as (string|number|boolean)[][];
    let windows: TimeWindow[] = [];

    // ×”××¨×ª ×”×©×•×¨×•×ª ×œ××‘× ×” × ×•×— ×œ×©×™×‘×•×¥
    // ×¢××•×“×•×ª 2+3 = ×™×•× 0, 4+5 = ×™×•× 1 ×•×›×•'
    vals.forEach(r => {
        let station = String(r[0]);
        for(let d=0; d<6; d++) { // ×¨××©×•×Ÿ ×¢×“ ×©×™×©×™
            let startIdx = 2 + (d * 2);
            let startVal = r[startIdx];
            let endVal = r[startIdx+1];
            
            if (startVal && endVal) {
                windows.push({
                    station: station,
                    dayIdx: d,
                    startMin: timeToMin(convertTime(startVal)),
                    endMin: timeToMin(convertTime(endVal))
                });
            }
        }
    });
    return windows;
}

function getStationsDB(): Station[] {
    // ×‘×¡×™×¡ × ×ª×•× ×™× ×§×©×™×— ×•×’×™××•×’×¨×¤×™ (×œ×¤×™ ×¡×“×¨ ×”×ª×—× ×•×ª)
    const rawData = [
        {n:"×ª\"× ×¤\"×ª", t:"AG", d:30, h:true}, {n:"×¤×™× ×¡×§×¨", t:"AG", d:30, h:false},
        {n:"×§×¨×•×œ", t:"AG", d:30, h:false}, {n:"×“× ×§× ×¨", t:"AG", d:30, h:false},
        {n:"×‘×œ×™× ×¡×•×Ÿ", t:"AG", d:45, h:false}, {n:"×©×—×", t:"AG", d:30, h:false},
        {n:"×©× ×§×¨", t:"AG", d:30, h:false}, {n:"×§×¨×™×™×ª ××¨×™×”", t:"AG", d:30, h:true},
        {n:"×× ×”××•×©×‘×•×ª", t:"UG", d:60, h:false}, {n:"××”×¨×•× ×•×‘×™×¥", t:"UG", d:60, h:false},
        {n:"×‘×Ÿ ×’×•×¨×™×•×Ÿ", t:"UG", d:60, h:false}, {n:"×‘×™××œ×™×§", t:"UG", d:60, h:false},
        {n:"××‘× ×”×œ×œ", t:"UG", d:60, h:false}, {n:"××¨×œ×•×–×•×¨×•×‘", t:"UG", d:60, h:false},
        {n:"×©××•×œ ×”××œ×š", t:"UG", d:60, h:false}, {n:"×™×”×•×“×™×ª", t:"UG", d:60, h:false},
        {n:"×§×¨×œ×™×‘×š", t:"UG", d:60, h:false}, {n:"××œ× ×‘×™", t:"UG", d:60, h:false},
        {n:"××œ×™×¤×œ×˜", t:"UG", d:60, h:true}, {n:"×©×œ××”", t:"AG", d:30, h:false},
        {n:"×‘×œ×•××¤×™×œ×“", t:"AG", d:30, h:false}, {n:"××¨×œ×™×š", t:"AG", d:30, h:false},
        {n:"××™×¡×§×•×‘", t:"AG", d:30, h:false}, {n:"×”×‘×¢×©\"×˜", t:"AG", d:30, h:false},
        {n:"××—×¨×•×–×ª", t:"AG", d:30, h:false}, {n:"×”×¢×¦×××•×ª", t:"AG", d:30, h:false},
        {n:"×¨×•×˜×©×™×œ×“", t:"AG", d:30, h:false}, {n:"×–'×‘×•×˜×™× ×¡×§×™", t:"AG", d:30, h:false},
        {n:"×‘×œ×¤×•×¨", t:"AG", d:30, h:false}, {n:"×‘× ×™××™×Ÿ", t:"AG", d:30, h:false},
        {n:"×™×•×¡×¤×˜×œ", t:"AG", d:30, h:false}, {n:"×›\"×˜ ×‘× ×•×‘××‘×¨", t:"AG", d:30, h:false},
        {n:"×”×¢××œ", t:"AG", d:30, h:false}, {n:"×”×§×•×××™×•×ª", t:"AG", d:30, h:true}
    ];

    // ×™×¦×™×¨×ª ×¨×©×™××” ××§×•×©×¨×ª (Linked List) ×œ×’×™××•×’×¨×¤×™×”
    return rawData.map((s, i) => ({
        id: i,
        name: s.n,
        type: s.t,
        duration: s.d,
        isHub: s.h,
        nextStation: i < rawData.length - 1 ? rawData[i+1].n : "",
        prevStation: i > 0 ? rawData[i-1].n : ""
    }));
}

// --- ×›×œ×™ ×¢×–×¨ ---

function timeToMin(t: string): number {
    if (!t || t.indexOf(":") === -1) return 0;
    let parts = t.split(":");
    let h = Number(parts[0]);
    let m = Number(parts[1]);
    if (isNaN(h) || isNaN(m)) return 0;
    return h * 60 + m;
}

function minToTime(m: number): string {
    let h = Math.floor(m / 60);
    let min = m % 60;
    return `${h.toString().padStart(2,'0')}:${min.toString().padStart(2,'0')}`;
}

function convertTime(v: string | number | boolean): string {
    if (typeof v === 'number') return minToTime(Math.round(v * 24 * 60));
    return String(v);
}

function formatHeader(r: ExcelScript.Range) {
    let fmt = r.getFormat();
    fmt.getFill().setColor("#1e293b");
    fmt.getFont().setColor("white");
    fmt.getFont().setBold(true);
    fmt.setHorizontalAlignment(ExcelScript.HorizontalAlignment.center);
}

function formatOutputTable(s: ExcelScript.Worksheet, r: ExcelScript.Range) {
    let fmt = r.getFormat();
    fmt.setWrapText(true);
    fmt.setVerticalAlignment(ExcelScript.VerticalAlignment.top);
    fmt.getFont().setSize(8.5);
    
    // ×’×‘×•×œ×•×ª
    let borderStyle = ExcelScript.BorderLineStyle.continuous;
    fmt.getRangeBorder(ExcelScript.BorderIndex.insideHorizontal).setStyle(borderStyle);
    fmt.getRangeBorder(ExcelScript.BorderIndex.insideVertical).setStyle(borderStyle);
    fmt.getRangeBorder(ExcelScript.BorderIndex.edgeBottom).setStyle(borderStyle);

    // ×¨×•×—×‘
    s.getRange("B:H").getFormat().setColumnWidth(170);
    s.getRange("A:A").getFormat().setColumnWidth(100);
}
