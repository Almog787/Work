/**
 * ××¢×¨×›×ª × ×™×”×•×œ ×‘×§×¨×ª ×¨×›×‘×ª ×§×œ×” - ×’×¨×¡×ª ×ª×¦×•×’×” ××©×•×¤×¨×ª (V11.0 Visual)
 * ×›×•×œ×œ ××™×™×§×•× ×™×, ××‘× ×” ××©×™××•×ª ×‘×¨×•×¨ ×•×¢×™×¦×•×‘ ×œ×•×— ××©×•×¤×¨
 */

interface TaskDefinition {
  name: string;
  duration: number;
  category: string;
}

interface ControllerData {
  name: string;
  start: string;
  end: string;
}

interface StationData {
  name: string;
  type: string;
}

function main(workbook: ExcelScript.Workbook) {
  // 1. ×”×§××ª ×ª×©×ª×™×•×ª
  ensureSheetWithData(workbook, "×”×’×“×¨×•×ª_××©×™××•×ª", getTaskDefaults());
  ensureSheetWithData(workbook, "×”×’×“×¨×•×ª_×‘×§×¨×™×", getControllerDefaults());
  ensureSheetWithData(workbook, "×”×’×“×¨×•×ª_×ª×—× ×•×ª", getStationDefaults()); 

  // 2. ×§×¨×™××ª × ×ª×•× ×™×
  const tasksDB: TaskDefinition[] = readTasks(workbook);
  const controllersDB: ControllerData[] = readControllers(workbook);
  const stationsDB: StationData[] = readStations(workbook);

  // 3. ×”×›× ×ª ×’×™×œ×™×•×Ÿ ×”×¡×™×“×•×¨
  let scheduleSheet = workbook.getWorksheet("×¡×™×“×•×¨_×¢×‘×•×“×”_×©×‘×•×¢×™");
  if (!scheduleSheet) {
    scheduleSheet = workbook.addWorksheet("×¡×™×“×•×¨_×¢×‘×•×“×”_×©×‘×•×¢×™");
  }
  
  let usedRange = scheduleSheet.getUsedRange();
  if (usedRange) {
    usedRange.clear();
  }

  // ×›×•×ª×¨×•×ª
  const days: string[] = ["×¨××©×•×Ÿ", "×©× ×™", "×©×œ×™×©×™", "×¨×‘×™×¢×™", "×—××™×©×™", "×©×™×©×™", "××•×¦\"×©"];
  const headers: string[][] = [["×‘×§×¨", ...days]];
  const headerRange = scheduleSheet.getRange("A1:H1");
  headerRange.setValues(headers);
  formatHeader(headerRange);

  // 4. ×× ×•×¢ ×”×©×™×‘×•×¥
  let outputMatrix: string[][] = [];

  for (let ctrl of controllersDB) {
    let row: string[] = [ctrl.name];
    for (let day = 0; day < 7; day++) {
      let dailyPlan: string = generateVisualDailyPlan(ctrl, day, tasksDB, stationsDB);
      row.push(dailyPlan);
    }
    outputMatrix.push(row);
  }

  // 5. ×›×ª×™×‘×ª ×”×ª×•×¦××•×ª ×œ×’×™×œ×™×•×Ÿ
  if (outputMatrix.length > 0) {
    let dataRange = scheduleSheet.getRangeByIndexes(1, 0, outputMatrix.length, 8);
    dataRange.setValues(outputMatrix);
    formatOutputTable(scheduleSheet, dataRange);
  }

  scheduleSheet.activate();
  console.log("×”×¡×™×“×•×¨ ×”×•×©×œ×! ×”×ª×¦×•×’×” ×©×•×¤×¨×” ×•×™×–×•××œ×™×ª.");
}

/**
 * ×™×¦×™×¨×ª ×œ×•"×– ×™×•××™ ×¢× ×ª×¦×•×’×” ×•×™×–×•××œ×™×ª ××©×•×¤×¨×ª
 */
function generateVisualDailyPlan(ctrl: ControllerData, dayIdx: number, tasks: TaskDefinition[], stations: StationData[]): string {
  let startStr: string = ctrl.start;
  let endStr: string = ctrl.end;

  if (dayIdx === 5) { startStr = "06:00"; endStr = "14:30"; } 
  if (dayIdx === 6) { startStr = "19:00"; endStr = "24:00"; } 

  let currentMin: number = timeToMin(startStr);
  let endMin: number = timeToMin(endStr);
  let planText: string = "";

  let availableTasks: TaskDefinition[] = [];
  tasks.forEach(t => availableTasks.push(t));
  
  while (currentMin < endMin - 15) {
    const timeLeft: number = endMin - currentMin;
    let possibleTasks: TaskDefinition[] = availableTasks.filter(t => t.duration <= timeLeft);
    
    if (possibleTasks.length === 0) break;

    let selectedTask: TaskDefinition = possibleTasks[Math.floor(Math.random() * possibleTasks.length)];
    let detail: string = "";
    let icon: string = "ğŸ“";

    // ×”×ª×××ª ××™×™×§×•×Ÿ ×•×¤×™×¨×•×˜
    switch(selectedTask.category) {
        case "STATION":
            icon = "ğŸš‰";
            let relevantStations = stations;
            if (selectedTask.name.indexOf("×ª×ª\"×§") >= 0) relevantStations = stations.filter(s => s.type === "UG");
            else relevantStations = stations.filter(s => s.type === "AG");
            if (relevantStations.length > 0) detail = relevantStations[Math.floor(Math.random() * relevantStations.length)].name;
            break;
        case "ONBOARD":
            icon = "ğŸš†";
            detail = selectedTask.name.split(" ").pop() || ""; // R1 or R3
            break;
        case "TRACK":
            icon = "ğŸ›¤ï¸";
            detail = "××§×˜×¢ " + (Math.floor(Math.random() * 20) + 1);
            break;
        case "KARON":
            icon = "âš™ï¸";
            const hubs: string[] = ["××œ×™×¤×œ×˜", "×§.××¨×™×”", "×¤\"×ª", "×§×•×××™×•×ª"];
            detail = hubs[Math.floor(Math.random() * hubs.length)];
            break;
        case "SERVICE":
            icon = "ğŸ“";
            break;
    }

    // ×‘× ×™×™×ª ×©×•×¨×ª ×”××©×™××” ×‘×¤×•×¨××˜ × ×§×™
    // [×©×¢×”] ×¡××œ ×©× ××©×™××” (××™×§×•×)
    planText += `[${minToTime(currentMin)}] ${icon} ${selectedTask.name} ${detail ? `(${detail})` : ""}\n`;
    planText += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`; // ×§×• ××¤×¨×™×“ ×‘×ª×•×š ×”×ª×

    currentMin += selectedTask.duration;
  }
  return planText;
}

// --- ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×•×¢×™×¦×•×‘ ---

function formatHeader(range: ExcelScript.Range) {
    let format = range.getFormat();
    format.getFill().setColor("#1e293b"); // ×›×—×•×œ ×›×”×” ×××•×“
    format.getFont().setColor("white");
    format.getFont().setBold(true);
    format.getFont().setSize(11);
    format.setHorizontalAlignment(ExcelScript.HorizontalAlignment.center);
}

function formatOutputTable(sheet: ExcelScript.Worksheet, range: ExcelScript.Range) {
    let format = range.getFormat();
    format.setWrapText(true);
    format.setVerticalAlignment(ExcelScript.VerticalAlignment.top);
    format.getFont().setSize(9); // ×¤×•× ×˜ ×§×¦×ª ×™×•×ª×¨ ×§×˜×Ÿ ×›×“×™ ×œ×”×›×™×œ ×™×•×ª×¨ ××™×“×¢
    
    // ×’×‘×•×œ×•×ª
    let borders = format.getRangeBorder(ExcelScript.BorderIndex.insideHorizontal);
    borders.setStyle(ExcelScript.BorderLineStyle.continuous);
    borders.setColor("#e2e8f0");

    // ×¦×‘×™×¢×ª ×©×•×¨×•×ª ×œ×¡×™×¨×•×’×™×Ÿ (Zebra)
    for (let i = 0; i < range.getRowCount(); i++) {
        if (i % 2 === 0) {
            range.getRow(i).getFormat().getFill().setColor("#ffffff");
        } else {
            range.getRow(i).getFormat().getFill().setColor("#f8fafc");
        }
    }

    // ×”×ª×××ª ×¨×•×—×‘
    sheet.getRange("B:H").getFormat().setColumnWidth(180);
    sheet.getRange("A:A").getFormat().setColumnWidth(100);
    sheet.getRange("A:A").getFormat().getFont().setBold(true);
}

// --- ×ª×©×ª×™×ª × ×ª×•× ×™× (×–×”×” ×œ×’×¨×¡×” ×”×§×•×“××ª ××š ×¢× ×˜×™×¤×•×¡×™× ××¤×•×¨×©×™×) ---

function ensureSheetWithData(workbook: ExcelScript.Workbook, sheetName: string, data: (string | number)[][]) {
  let sheet = workbook.getWorksheet(sheetName);
  if (!sheet) {
    sheet = workbook.addWorksheet(sheetName);
    let range = sheet.getRangeByIndexes(0, 0, data.length, data[0].length);
    range.setValues(data);
    let table = workbook.addTable(range, true);
    table.setName(sheetName + "_TBL");
    sheet.getRangeByIndexes(0, 0, 1, data[0].length).getFormat().getFill().setColor("#3b82f6");
    sheet.getRangeByIndexes(0, 0, 1, data[0].length).getFormat().getFont().setColor("white");
    sheet.getUsedRange().getFormat().autofitColumns();
  }
}

function readTasks(workbook: ExcelScript.Workbook): TaskDefinition[] {
  let table = workbook.getTable("×”×’×“×¨×•×ª_××©×™××•×ª_TBL");
  let values = table.getRangeBetweenHeaderAndTotal().getValues() as (string | number | boolean)[][];
  return values.map(row => ({ name: row[0] as string, duration: Number(row[1]), category: row[2] as string }));
}

function readControllers(workbook: ExcelScript.Workbook): ControllerData[] {
  let table = workbook.getTable("×”×’×“×¨×•×ª_×‘×§×¨×™×_TBL");
  let values = table.getRangeBetweenHeaderAndTotal().getValues() as (string | number | boolean)[][];
  return values.map(row => ({ name: row[0] as string, start: convertExcelTime(row[1]), end: convertExcelTime(row[2]) }));
}

function readStations(workbook: ExcelScript.Workbook): StationData[] {
  let table = workbook.getTable("×”×’×“×¨×•×ª_×ª×—× ×•×ª_TBL");
  let values = table.getRangeBetweenHeaderAndTotal().getValues() as (string | number | boolean)[][];
  return stationsDB = values.map(row => ({ name: row[0] as string, type: row[1] as string }));
}

function timeToMin(t: string): number {
    let parts = t.split(":");
    return parts.length < 2 ? 0 : parseInt(parts[0]) * 60 + parseInt(parts[1]);
}

function minToTime(mins: number): string {
    let h = Math.floor(mins / 60);
    let m = mins % 60;
    return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
}

function convertExcelTime(val: string | number | boolean): string {
    if (typeof val === 'string') return val;
    if (typeof val === 'number') return minToTime(Math.round(val * 24 * 60));
    return "00:00";
}

// --- Defaults ---
function getTaskDefaults() {
  return [
    ["××©×™××”", "×“×§×•×ª", "×§×˜×’×•×¨×™×”"],
    ["×‘×§×¨×ª ×ª×—× ×” ×ª×ª\"×§", 60, "STATION"], ["×‘×§×¨×ª ×ª×—× ×” ×¢×™×œ×™×ª", 30, "STATION"],
    ["×‘×§×¨×ª ×§×¨×•× ×•×ª", 65, "KARON"], ["××•× ×‘×•×¨×“ R1", 80, "ONBOARD"],
    ["××•× ×‘×•×¨×“ R3", 45, "ONBOARD"], ["× ×™×§×™×•×Ÿ ××¡×™×œ×”", 30, "TRACK"],
    ["××¨×›×– ×©×™×¨×•×ª", 15, "SERVICE"], ["××•×§×“", 15, "SERVICE"]
  ];
}

function getControllerDefaults() {
  return [
    ["×©×", "×”×ª×—×œ×”", "×¡×™×•×"],
    ["××•×¨×™ ××™×™×–×œ×¨", "07:00", "16:00"], ["××™× ×” ×˜×™××•×¤×™×™×‘", "07:00", "16:00"],
    ["×“×•×“ ×¡×™×™×’", "07:00", "16:00"], ["×‘×ª×™×” ××‘×™×”", "09:00", "18:00"],
    ["×”×¨×¦×œ ×©×’×‘", "14:00", "23:00"], ["×™×•× ×™ ×™×•×¡×£", "14:00", "23:00"]
  ];
}

function getStationDefaults() {
  return [
    ["×ª×—× ×”", "×¡×•×’"],
    ["××œ× ×‘×™", "UG"], ["×§×¨×œ×™×‘×š", "UG"], ["×™×”×•×“×™×ª", "UG"], ["×©××•×œ ×”××œ×š", "UG"],
    ["×”×§×•×××™×•×ª", "AG"], ["×™×•×¡×¤×˜×œ", "AG"], ["×‘×œ×¤×•×¨", "AG"], ["×‘×œ×™× ×¡×•×Ÿ", "AG"]
  ];
}
