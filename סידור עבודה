/**
 * RedLine OS V20.0 - ××¢×¨×›×ª × ×™×”×•×œ ×‘×§×¨×ª ×¨×›×‘×ª ×§×œ×”
 * ×›×•×œ×œ: × ×™×”×•×œ ×™×¢×“×™× ×—×•×“×©×™, ×—×œ×•× ×•×ª ×–××Ÿ ×“×™× ××™×™×, ××™×œ×•×¦×™ ×§×¨×•× ×•×ª, ×•×× ×™×¢×ª ×—×¤×™×¤×•×ª.
 */

// --- ×××©×§×™× (Interfaces) ---

interface Station {
  name: string;
  type: string; // UG, AG
  duration: number; // ×“×§×•×ª
  isHub: boolean; // ×”×× ×ª×—× ×ª ×§×¦×” ×œ×§×¨×•× ×•×ª
}

interface TimeWindow {
  station: string;
  dayIdx: number; // 0-6
  startMin: number;
  endMin: number;
}

interface Controller {
  name: string;
  start: string;
  end: string;
}

interface MonthlyKPI {
  id: string;
  category: string;
  target: number;
  done: number;
}

interface TaskResult {
  text: string;
  duration: number;
  kpiId: string; // ×œ×§×™×©×•×¨ ×œ×˜×‘×œ×ª ×”×™×¢×“×™×
}

function main(workbook: ExcelScript.Workbook) {
  // 1. ×”×§××ª ×ª×©×ª×™×•×ª × ×ª×•× ×™× (×× ×œ× ×§×™×™××•×ª)
  setupDashboard(workbook);
  setupKPITable(workbook);
  setupControllers(workbook);
  setupTimeWindows(workbook); // ×‘×•× ×” ××ª ×˜×‘×œ×ª ×”×©×¢×•×ª ×”×“×™× ××™×ª

  // 2. ×§×¨×™××ª ×”×’×“×¨×•×ª ××œ×•×— ×”×‘×§×¨×”
  const dashSheet = workbook.getWorksheet("×œ×•×—_×‘×§×¨×”");
  const startDateValue = dashSheet.getRange("C3").getValue() as number;
  const syncMode = dashSheet.getRange("C4").getValue() === "×›×Ÿ - ×¡× ×›×¨×Ÿ ×•×¢×“×›×Ÿ ×™×¢×“×™×";
  
  // ×ª××¨×™×š ×”×ª×—×œ×” ×œ×—×™×©×•×‘ ×›×•×ª×¨×•×ª
  let baseDate = new Date();
  if (startDateValue) {
    baseDate = new Date(Math.round((startDateValue - 25569) * 86400 * 1000));
  }

  // 3. ×˜×¢×™× ×ª × ×ª×•× ×™× ×œ×–×™×›×¨×•×Ÿ
  const controllers = readControllers(workbook);
  const stationsDB = getStationsDB();
  const timeWindows = readTimeWindows(workbook);
  const kpiMap = readKPIs(workbook);

  // 4. ×”×›× ×ª ×’×™×œ×™×•×Ÿ ×”×¡×™×“×•×¨
  let scheduleSheet = workbook.getWorksheet("×¡×™×“×•×¨_×¢×‘×•×“×”");
  if (!scheduleSheet) scheduleSheet = workbook.addWorksheet("×¡×™×“×•×¨_×¢×‘×•×“×”");
  
  scheduleSheet.getUsedRange()?.clear(); // × ×™×§×•×™

  // ×›×•×ª×¨×•×ª ×¢× ×ª××¨×™×›×™×
  let headers = ["×‘×§×¨"];
  const dayNames = ["×¨××©×•×Ÿ", "×©× ×™", "×©×œ×™×©×™", "×¨×‘×™×¢×™", "×—××™×©×™", "×©×™×©×™", "××•×¦\"×©"];
  for(let i=0; i<7; i++) {
      let d = new Date(baseDate);
      d.setDate(d.getDate() + i);
      headers.push(`${dayNames[i]} (${d.getDate()}/${d.getMonth()+1})`);
  }
  
  scheduleSheet.getRange("A1:H1").setValues([headers]);
  formatHeader(scheduleSheet.getRange("A1:H1"));

  // 5. ×× ×•×¢ ×©×™×‘×•×¥ ×¨××©×™
  let outputMatrix: string[][] = [];
  
  // ××¢×§×‘ ×©×™×‘×•×¥ ×œ×”×¨×¦×” ×”× ×•×›Ø­ÙŠØ© (×œ×¦×•×¨×š ×¡× ×›×¨×•×Ÿ)
  let sessionStats = new Map<string, number>();

  // ××¢×§×‘ ×™×•××™ ×’×œ×•×‘×œ×™ ×œ×× ×™×¢×ª ×›×¤×™×œ×•×ª ×ª×—× ×” ×‘××•×ª×• ×™×•×
  let dailyStationTracker: Set<string>[] = [];
  for(let i=0; i<7; i++) dailyStationTracker.push(new Set<string>());

  for (let ctrl of controllers) {
    let row: string[] = [ctrl.name];
    for (let day = 0; day < 7; day++) {
      let plan = generateDayPlan(
          ctrl, day, stationsDB, timeWindows, 
          kpiMap, dailyStationTracker[day], sessionStats
      );
      row.push(plan);
    }
    outputMatrix.push(row);
  }

  // 6. ×›×ª×™×‘×” ×œ××§×¡×œ
  if (outputMatrix.length > 0) {
    let rng = scheduleSheet.getRangeByIndexes(1, 0, outputMatrix.length, 8);
    rng.setValues(outputMatrix);
    formatOutputTable(scheduleSheet, rng);
  }

  // 7. ×¢×“×›×•×Ÿ ×™×¢×“×™× (×× × ×‘×—×¨)
  if (syncMode) {
    updateKPIs(workbook, sessionStats);
    dashSheet.getRange("C6").setValue("×‘×•×¦×¢ ×¡× ×›×¨×•×Ÿ ××—×¨×•×Ÿ: " + new Date().toLocaleString());
  } else {
    dashSheet.getRange("C6").setValue("××¦×‘ ×˜×™×•×˜×” (×œ× ×‘×•×¦×¢ ×¡× ×›×¨×•×Ÿ)");
  }

  scheduleSheet.activate();
}

/**
 * ×”××•×—: ×™×¦×™×¨×ª ×™×•× ×¢×‘×•×“×” ×œ×¤×™ ×›×œ ×”××™×œ×•×¦×™×
 */
function generateDayPlan(
    ctrl: Controller, 
    dayIdx: number, 
    stations: Station[], 
    windows: TimeWindow[], 
    kpiMap: Map<string, MonthlyKPI>,
    dailyVisited: Set<string>,
    sessionStats: Map<string, number>
): string {

  // ×”×ª×××ª ×©×¢×•×ª ×™×•××™×ª
  let sTime = ctrl.start;
  let eTime = ctrl.end;
  if (dayIdx === 5) { sTime = "06:00"; eTime = "14:30"; } // ×•'
  if (dayIdx === 6) { sTime = "19:00"; eTime = "24:00"; } // ×©'

  let currentMin = timeToMin(sTime);
  let endMin = timeToMin(eTime);
  let planText = "";
  
  // ××™×§×•× × ×•×›×—×™ (×œ×¨×¦×£ ×’××•×’×¨×¤×™)
  let currentLocation = "×ª\"× ×¤\"×ª"; 
  let karonPerformed = false;

  while (currentMin < endMin - 15) {
    let timeLeft = endMin - currentMin;
    let selectedTask: TaskResult | null = null;

    // --- ××™×œ×•×¥ 1: ×§×¨×•× ×•×ª (×—×•×‘×” ×‘×•×§×¨/×¢×¨×‘ ×‘×ª×—× ×•×ª ×§×¦×”) ---
    // ×× ×™×© ×–××Ÿ ×œ×‘×œ×•×§ ×›×¤×•×œ (130 ×“×§) ××• ×‘×•×“×“ (65) ×•×–×” ×‘×˜×•×•×— ×”×©×¢×•×ª
    if (!karonPerformed && timeLeft >= 65) {
        let isMorningSlot = currentMin >= 360 && currentMin < 840; // 06-14
        let isEveningSlot = currentMin >= 840 && currentMin < 1320; // 14-22
        
        // ×¢×“×™×¤×•×ª ×œ×§×¨×•× ×•×ª ×× ×× ×—× ×• ×‘×—×œ×•×Ÿ ×”××ª××™× ×•×¢×“×™×™×Ÿ ×™×© ×¦×•×¨×š ×—×•×“×©×™
        let karonKPI = kpiMap.get("KARON_TOTAL");
        let needKaron = karonKPI && karonKPI.target > karonKPI.done;

        if ((isMorningSlot || isEveningSlot) && needKaron) {
            // ×”×× ×œ×‘×¦×¢ ×›×¤×•×œ?
            let duration = (timeLeft >= 130) ? 130 : 65;
            let hub = stations.filter(s => s.isHub)[Math.floor(Math.random()*4)].name;
            
            selectedTask = {
                text: `âš™ï¸ ×‘×§×¨×ª ×§×¨×•× ×•×ª (${hub})`,
                duration: duration,
                kpiId: "KARON_TOTAL"
            };
            karonPerformed = true;
            currentLocation = hub;
        }
    }

    // --- ××™×œ×•×¥ 2: ×ª×—× ×•×ª ×œ×¤×™ ×—×œ×•×Ÿ ×–××Ÿ ×“×™× ××™ ---
    if (!selectedTask) {
        // ××¦×™××ª ×—×œ×•× ×•×ª ×©×¤×ª×•×—×™× *×¢×›×©×™×•* ×‘×™×•× *×”×–×”*
        let activeWindows = windows.filter(w => 
            w.dayIdx === dayIdx && 
            currentMin >= w.startMin && 
            currentMin <= w.endMin - 30 && // ×™×© ××¡×¤×™×§ ×–××Ÿ ×œ×”×ª×—×™×œ
            !dailyVisited.has(w.station) // ×”×ª×—× ×” ×œ× × ×‘×“×§×” ×”×™×•× ×¢"×™ ××£ ××—×“
        );

        if (activeWindows.length > 0) {
            // ××™×•×Ÿ: ×§×•×“× ×ª×—× ×•×ª ×©×§×¨×•×‘×•×ª ×œ××™×§×•× ×”× ×•×›×—×™, ×•××– ×œ×¤×™ ×¦×•×¨×š ×—×•×“×©×™
            activeWindows.sort((a, b) => {
                let distA = getDistance(currentLocation, a.station, stations);
                let distB = getDistance(currentLocation, b.station, stations);
                if (distA !== distB) return distA - distB; // ×§×¨×•×‘ ×™×•×ª×¨ ×× ×¦×—
                
                // ×× ××¨×—×§ ×–×”×”, ××™ ×©×™×© ×œ×• ×™×•×ª×¨ "×—×•×‘" ×—×•×“×©×™
                let kpiA = kpiMap.get(a.station);
                let kpiB = kpiMap.get(b.station);
                let remA = kpiA ? (kpiA.target - kpiA.done) : 0;
                let remB = kpiB ? (kpiB.target - kpiB.done) : 0;
                return remB - remA;
            });

            let win = activeWindows[0];
            let stData = stations.find(s => s.name === win.station);
            
            if (stData && stData.duration <= timeLeft) {
                selectedTask = {
                    text: `ğŸš‰ ${stData.name} (${stData.type})`,
                    duration: stData.duration,
                    kpiId: stData.name
                };
                dailyVisited.add(stData.name); // × ×¢×œ× ×• ××ª ×”×ª×—× ×” ×œ×”×™×•× ×œ×›×•×œ×
                currentLocation = stData.name;
            }
        }
    }

    // --- ××™×œ×•×¥ 3: ××¡×™×œ×•×ª / ××•× ×‘×•×¨×“ / ×©×™×¨×•×ª (××™×œ×•×™) ---
    if (!selectedTask) {
        // ×©×™×¨×•×ª (×—×•×‘×” ×¤×¢× ×‘×™×•× ×× ××¤×©×¨)
        if (timeLeft >= 15 && Math.random() > 0.8) {
             selectedTask = { text: "ğŸ“ ×©×™×¨×•×ª ×œ× ×•×¡×¢", duration: 15, kpiId: "SERVICE_TOTAL" };
        }
        // ××¡×œ×•×œ ××œ× R1 (80 ×“×§)
        else if (timeLeft >= 80 && Math.random() > 0.6) {
             selectedTask = { text: "ğŸš† ××•× ×‘×•×¨×“ R1 ××œ×", duration: 80, kpiId: "ONBOARD_TOTAL" };
             currentLocation = (currentLocation === "×ª\"× ×¤\"×ª") ? "×”×§×•×××™×•×ª" : "×ª\"× ×¤\"×ª"; // ×”×—×œ×¤×ª ×¦×“
        }
        // × ×™×§×™×•×Ÿ ××¡×™×œ×” (30 ×“×§)
        else if (timeLeft >= 30) {
             selectedTask = { text: "ğŸ›¤ï¸ × ×™×§×™×•×Ÿ ××¡×™×œ×”", duration: 30, kpiId: "TRACK_TOTAL" };
        }
        // ××•× ×‘×•×¨×“ ×§×¦×¨
        else if (timeLeft >= 15) {
             selectedTask = { text: "ğŸš† × ×¡×™×¢×” ×× ×”×œ×ª×™×ª", duration: 15, kpiId: "ONBOARD_TOTAL" };
        }
    }

    if (!selectedTask) break; // ××™×Ÿ ××” ×œ×¢×©×•×ª, ×¡×™×•× ×™×•×

    // ×¨×™×©×•× ×œ×¤×œ×˜
    let timeStr = minToTime(currentMin);
    planText += `[${timeStr}] ${selectedTask.text}\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
    
    // ×¢×“×›×•×Ÿ ××•× ×” ×–×× ×™ ×œ×¡× ×›×¨×•×Ÿ
    let currentVal = sessionStats.get(selectedTask.kpiId) || 0;
    // ×× ×–×” ×§×¨×•× ×•×ª, ××•×¡×™×¤×™× ×©×¢×•×ª, ××—×¨×ª ×™×—×™×“×•×ª
    let valToAdd = (selectedTask.kpiId === "KARON_TOTAL") ? (selectedTask.duration/60) : 1;
    sessionStats.set(selectedTask.kpiId, currentVal + valToAdd);

    currentMin += selectedTask.duration;
  }

  return planText;
}

// --- ×¤×•× ×§×¦×™×•×ª ×ª×©×ª×™×ª (Setup & Database) ---

function setupDashboard(wb: ExcelScript.Workbook) {
    let sheet = wb.getWorksheet("×œ×•×—_×‘×§×¨×”");
    if (!sheet) {
        sheet = wb.addWorksheet("×œ×•×—_×‘×§×¨×”");
        sheet.getRange("B2:D6").getFormat().getFill().setColor("#f3f4f6");
        
        sheet.getRange("C2").setValue("×œ×•×— ×‘×§×¨×” ×¨××©×™ - RedLine Scheduler");
        sheet.getRange("C2").getFormat().getFont().setBold(true);
        sheet.getRange("C2").getFormat().getFont().setSize(14);

        sheet.getRange("B3").setValue("×ª××¨×™×š ×”×ª×—×œ×” (×™×•× ×'):");
        sheet.getRange("C3").setValue(46050); // ×¢×¨×š ×”×ª×—×œ×ª×™
        
        sheet.getRange("B4").setValue("××¦×‘ ×¡× ×›×¨×•×Ÿ:");
        sheet.getRange("C4").setValue("×œ× - ×˜×™×•×˜×” ×‘×œ×‘×“");
        let dv = sheet.getRange("C4").getDataValidation();
        dv.setRule({ list: { inCellDropDown: true, source: "×œ× - ×˜×™×•×˜×” ×‘×œ×‘×“,×›×Ÿ - ×¡× ×›×¨×Ÿ ×•×¢×“×›×Ÿ ×™×¢×“×™×" } });

        sheet.getRange("B5").setValue("×¡×˜×˜×•×¡:");
        sheet.getRange("C6").setValue("××•×›×Ÿ ×œ×¢×‘×•×“×”");
        
        sheet.getUsedRange().getFormat().autofitColumns();
    }
}

function setupKPITable(wb: ExcelScript.Workbook) {
    let sheet = wb.getWorksheet("×™×¢×“×™×_×—×•×“×©×™×™×");
    if (!sheet) {
        sheet = wb.addWorksheet("×™×¢×“×™×_×—×•×“×©×™×™×");
        let data: (string|number)[][] = [["×§×•×“", "×ª×™××•×¨", "×™×¢×“", "×‘×•×¦×¢", "× ×•×ª×¨"]];
        
        // ×”×•×¡×¤×ª ×ª×—× ×•×ª
        getStationsDB().forEach(s => data.push([s.name, `×‘×§×¨×ª ${s.name}`, 20, 0, 20]));
        
        // ×™×¢×“×™× ×›×œ×œ×™×™×
        data.push(["KARON_TOTAL", "×©×¢×•×ª ×§×¨×•× ×•×ª (×—×•×“×©×™)", 1700, 0, 1700]);
        data.push(["ONBOARD_TOTAL", "××•× ×‘×•×¨×“ (×™×—×™×“×•×ª)", 720, 0, 720]);
        data.push(["TRACK_TOTAL", "× ×™×§×™×•×Ÿ ××¡×™×œ×•×ª", 84, 0, 84]);
        data.push(["SERVICE_TOTAL", "×©×™×¨×•×ª ×œ× ×•×¡×¢", 150, 0, 150]);

        sheet.getRange("A1:E1").getFormat().getFill().setColor("#1e293b");
        sheet.getRange("A1:E1").getFormat().getFont().setColor("white");
        
        let r = sheet.getRangeByIndexes(0, 0, data.length, 5);
        r.setValues(data);
        sheet.addTable(r, true).setName("Monthly_KPIs_Table");
        
        // × ×•×¡×—×” ×œ×™×ª×¨×”
        sheet.getRangeByIndexes(1, 4, data.length-1, 1).setFormula("=C2-D2");
    }
}

function setupTimeWindows(wb: ExcelScript.Workbook) {
    // ×‘×•× ×” ××ª ×˜×‘×œ×ª ×—×œ×•× ×•×ª ×”×–××Ÿ ×”×“×™× ××™×ª (×”×¡×˜×” ×©×œ 2.5 ×©×¢×•×ª)
    let sheet = wb.getWorksheet("×—×œ×•× ×•×ª_×–××Ÿ");
    if (!sheet) {
        sheet = wb.addWorksheet("×—×œ×•× ×•×ª_×–××Ÿ");
        let headers = ["×ª×—× ×”", "×™×•×", "×”×ª×—×œ×”", "×¡×™×•×"];
        let data: (string|number)[][] = [headers];
        
        let stations = getStationsDB();
        
        // ×œ×•×’×™×§×” ×œ×™×™×¦×•×¨ ×”×˜×‘×œ×” ×‘××•×¤×Ÿ ××•×˜×•××˜×™ (Staggered)
        stations.forEach((st, idx) => {
            for (let d = 0; d < 6; d++) { // ×-×•
                // ×—×™×©×•×‘ ×©×¢×ª ×”×ª×—×œ×” ×‘×¡×™×¡×™×ª + ×”×–×–×” ×œ×¤×™ ××™× ×“×§×¡ ×”×ª×—× ×” ×•×œ×¤×™ ×”×™×•×
                // ×›×œ ×ª×—× ×” ×–×–×” ×‘-20 ×“×§×•×ª, ×›×œ ×™×•× ×–×– ×‘-2.5 ×©×¢×•×ª
                let baseMin = 340 + (idx * 20) + (d * 150); 
                
                // × ×¨××•×œ ×œ×™×•× ×¢×‘×•×“×” (05:40 - 24:00)
                while (baseMin > 1380) baseMin -= 900; 
                
                let endMin = baseMin + 150; // ×—×œ×•×Ÿ ×©×œ 2.5 ×©×¢×•×ª
                
                data.push([st.name, d, minToTime(baseMin), minToTime(endMin)]);
            }
        });
        
        let rng = sheet.getRangeByIndexes(0, 0, data.length, 4);
        rng.setValues(data);
        sheet.addTable(rng, true).setName("TimeWindowsTable");
    }
}

function setupControllers(wb: ExcelScript.Workbook) {
    if (!wb.getWorksheet("×‘×§×¨×™×")) {
        let sheet = wb.addWorksheet("×‘×§×¨×™×");
        let data = [
            ["×©×", "×”×ª×—×œ×”", "×¡×™×•×"],
            ["××•×¨×™ ××™×™×–×œ×¨", "07:00", "16:00"], ["××™× ×” ×˜×™××•×¤×™×™×‘", "07:00", "16:00"],
            ["××œ×ª×™ ×§×¨××•", "08:00", "17:00"], ["×‘×•×¨×™×¡ ×“×•×œ×¦×™×’×¨", "06:00", "15:00"],
            ["×‘×ª×™×” ××‘×™×”", "09:00", "18:00"], ["×“×•×“ ×¡×™×™×’", "07:00", "16:00"],
            ["×”×¨×¦×œ ×©×’×‘", "14:00", "23:00"], ["×™×•× ×™ ×™×•×¡×£", "14:00", "23:00"],
            ["××©×” ××œ×™×”×•", "15:00", "23:00"], ["×¢×¨×Ÿ × ×™×¦×Ÿ", "06:00", "15:00"],
            ["×¨×•×Ÿ ×˜×•×‘", "07:00", "16:00"], ["××‘×¨×”× ×’×‘×¨×™×œ×‘×™×¥", "08:00", "17:00"],
            ["×’×“×™ ×‘×Ÿ ××•×¨", "10:00", "19:00"], ["×™×•× ×™ × ×™×¡×Ÿ", "12:00", "21:00"]
        ];
        sheet.getRangeByIndexes(0,0,data.length, 3).setValues(data);
        sheet.addTable(sheet.getUsedRange(), true).setName("ControllersTbl");
    }
}

// --- ×¤×•× ×§×¦×™×•×ª ×§×¨×™××” ×•×¢×“×›×•×Ÿ (IO) ---

function readControllers(wb: ExcelScript.Workbook): Controller[] {
    let tbl = wb.getTable("ControllersTbl");
    let vals = tbl.getRangeBetweenHeaderAndTotal().getValues() as (string|number|boolean)[][];
    return vals.map(r => ({ name: String(r[0]), start: convertTime(r[1]), end: convertTime(r[2]) }));
}

function readKPIs(wb: ExcelScript.Workbook): Map<string, MonthlyKPI> {
    let map = new Map<string, MonthlyKPI>();
    let tbl = wb.getTable("Monthly_KPIs_Table");
    let vals = tbl.getRangeBetweenHeaderAndTotal().getValues() as (string|number)[][];
    vals.forEach(r => {
        map.set(String(r[0]), { id: String(r[0]), category: "", target: Number(r[2]), done: Number(r[3]) });
    });
    return map;
}

function readTimeWindows(wb: ExcelScript.Workbook): TimeWindow[] {
    let tbl = wb.getTable("TimeWindowsTable");
    let vals = tbl.getRangeBetweenHeaderAndTotal().getValues() as (string|number|boolean)[][];
    return vals.map(r => ({
        station: String(r[0]),
        dayIdx: Number(r[1]),
        startMin: timeToMin(convertTime(r[2])),
        endMin: timeToMin(convertTime(r[3]))
    }));
}

function updateKPIs(wb: ExcelScript.Workbook, stats: Map<string, number>) {
    let tbl = wb.getTable("Monthly_KPIs_Table");
    let range = tbl.getRangeBetweenHeaderAndTotal();
    let vals = range.getValues() as (string|number)[][];
    
    // ×¢×“×›×•×Ÿ ×”×¢×¨×›×™× ×‘×–×™×›×¨×•×Ÿ
    let newVals = vals.map(row => {
        let id = String(row[0]);
        if (stats.has(id)) {
            let added = stats.get(id);
            if (added !== undefined) {
                row[3] = Number(row[3]) + added;
            }
        }
        return row;
    });
    
    range.setValues(newVals);
}

// --- × ×ª×•× ×™× ×¡×˜×˜×™×™× (DB) ---

function getStationsDB(): Station[] {
    return [
        {name: "×”×§×•×××™×•×ª", type: "AG", duration: 30, isHub: true},
        {name: "×”×¢××œ", type: "AG", duration: 30, isHub: false},
        {name: "×›\"×˜ ×‘× ×•×‘××‘×¨", type: "AG", duration: 30, isHub: false},
        {name: "×™×•×¡×¤×˜×œ", type: "AG", duration: 30, isHub: false},
        {name: "×‘× ×™××™×Ÿ", type: "AG", duration: 30, isHub: false},
        {name: "×‘×œ×¤×•×¨", type: "AG", duration: 30, isHub: false},
        {name: "×–'×‘×•×˜×™× ×¡×§×™", type: "AG", duration: 30, isHub: false},
        {name: "×¨×•×˜×©×™×œ×“", type: "AG", duration: 30, isHub: false},
        {name: "×”×¢×¦×××•×ª", type: "AG", duration: 30, isHub: false},
        {name: "××—×¨×•×–×ª", type: "AG", duration: 30, isHub: false},
        {name: "×”×‘×¢×©\"×˜", type: "AG", duration: 30, isHub: false},
        {name: "××™×¡×§×•×‘", type: "AG", duration: 30, isHub: false},
        {name: "××¨×œ×™×š", type: "AG", duration: 30, isHub: false},
        {name: "×‘×œ×•××¤×™×œ×“", type: "AG", duration: 30, isHub: false},
        {name: "×©×œ××”", type: "AG", duration: 30, isHub: false},
        {name: "××œ×™×¤×œ×˜", type: "AG", duration: 60, isHub: true}, // ×—×¨×™×’ ×–××Ÿ
        {name: "××œ× ×‘×™", type: "UG", duration: 60, isHub: false},
        {name: "×§×¨×œ×™×‘×š", type: "UG", duration: 60, isHub: false},
        {name: "×™×”×•×“×™×ª", type: "UG", duration: 60, isHub: false},
        {name: "×©××•×œ ×”××œ×š", type: "UG", duration: 60, isHub: false},
        {name: "××¨×œ×•×–×•×¨×•×‘", type: "UG", duration: 60, isHub: false},
        {name: "××‘× ×”×œ×œ", type: "UG", duration: 60, isHub: false},
        {name: "×‘×™××œ×™×§", type: "UG", duration: 60, isHub: false},
        {name: "×‘×Ÿ ×’×•×¨×™×•×Ÿ", type: "UG", duration: 60, isHub: false},
        {name: "××”×¨×•× ×•×‘×™×¥", type: "UG", duration: 60, isHub: false},
        {name: "×× ×”××•×©×‘×•×ª", type: "UG", duration: 60, isHub: false},
        {name: "×§×¨×™×™×ª ××¨×™×”", type: "AG", duration: 30, isHub: true},
        {name: "×©× ×§×¨", type: "AG", duration: 30, isHub: false},
        {name: "×©×—×", type: "AG", duration: 30, isHub: false},
        {name: "×‘×œ×™× ×¡×•×Ÿ", type: "AG", duration: 45, isHub: false}, // ×—×¨×™×’ ×–××Ÿ
        {name: "×“× ×§× ×¨", type: "AG", duration: 30, isHub: false},
        {name: "×§×¨×•×œ", type: "AG", duration: 30, isHub: false},
        {name: "×¤×™× ×¡×§×¨", type: "AG", duration: 30, isHub: false},
        {name: "×ª\"× ×¤\"×ª", type: "AG", duration: 30, isHub: true}
    ];
}

// --- ×›×œ×™ ×¢×–×¨ ---

function timeToMin(t: string): number {
    if (!t || t.indexOf(":") === -1) return 0;
    let parts = t.split(":");
    return Number(parts[0]) * 60 + Number(parts[1]);
}

function minToTime(m: number): string {
    return `${Math.floor(m/60).toString().padStart(2,'0')}:${(m%60).toString().padStart(2,'0')}`;
}

function convertTime(v: string | number | boolean): string {
    if (typeof v === 'number') return minToTime(Math.round(v * 24 * 60));
    return String(v);
}

// ×—×™×©×•×‘ ××¨×—×§ ×¤×©×•×˜ ×œ×¤×™ ××™× ×“×§×¡ ×‘××¢×¨×š (×× ×™×— ×¡×“×¨ ×’×™××•×’×¨×¤×™)
function getDistance(stA: string, stB: string, list: Station[]): number {
    let idxA = -1, idxB = -1;
    for(let i=0; i<list.length; i++) {
        if (list[i].name === stA) idxA = i;
        if (list[i].name === stB) idxB = i;
    }
    if (idxA === -1 || idxB === -1) return 100; // ×¨×—×•×§ ×××•×“ ×× ×œ× × ××¦×
    return Math.abs(idxA - idxB);
}

function formatHeader(r: ExcelScript.Range) {
    let f = r.getFormat();
    f.getFill().setColor("#1e293b");
    f.getFont().setColor("white");
    f.getFont().setBold(true);
    f.setHorizontalAlignment(ExcelScript.HorizontalAlignment.center);
}

function formatOutputTable(s: ExcelScript.Worksheet, r: ExcelScript.Range) {
    let f = r.getFormat();
    f.setWrapText(true);
    f.setVerticalAlignment(ExcelScript.VerticalAlignment.top);
    f.getFont().setSize(8);
    s.getRange("B:H").getFormat().setColumnWidth(160);
    s.getRange("A:A").getFormat().setColumnWidth(100);
    
    let borders = f.getRangeBorder(ExcelScript.BorderIndex.insideHorizontal);
    borders.setStyle(ExcelScript.BorderLineStyle.continuous);
    borders.setColor("#e2e8f0");
}
