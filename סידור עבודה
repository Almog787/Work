// הגדרת מבנה הנתונים של בקר כדי למנוע שגיאות קומפילציה
interface Controller {
  rowIndex: number;
  name: string;
  jobType: string;
  assignedCount: number;
  maxShifts: number;
}

function main(workbook: ExcelScript.Workbook, sheetName: string = "01.02.2026-07.02.2026") {
  // 1. גישה לגיליון
  let sheet = workbook.getWorksheet(sheetName);
  
  if (!sheet) {
    console.log(`שגיאה: הגיליון בשם "${sheetName}" לא נמצא.`);
    return;
  }

  // 2. קריאת הנתונים
  let range = sheet.getUsedRange();
  let data = range.getValues();

  // מיפוי עמודות לפי הצילום (A=0, B=1, C=2...)
  const COL_NAME = 1;      // עמודה B: שם הבקר
  const COL_JOB_TYPE = 11; // עמודה L: סוג משרה (משרה מלאה/חלקית)
  const START_ROW = 2;     // שורה שבה מתחילים השמות (אחרי הכותרות)

  // עמודות הימים: ראשון (C=2) עד מוצ"ש (I=8)
  const DAY_COLUMNS = [2, 3, 4, 5, 6, 7, 8];

  // 3. יצירת רשימת הבקרים עם הגדרת סוג מפורשת (פותר את השגיאה שציינת)
  let controllers: Controller[] = [];

  for (let i = START_ROW; i < data.length; i++) {
    let name = data[i][COL_NAME] as string;
    let jobTypeStr = data[i][COL_JOB_TYPE] as string || "";

    if (name && name.trim() !== "") {
      controllers.push({
        rowIndex: i,
        name: name,
        jobType: jobTypeStr,
        assignedCount: 0,
        // קביעת מכסה: משרה מלאה = 5 משמרות, אחרת 3 (ניתן לשינוי)
        maxShifts: jobTypeStr.includes("מלאה") ? 5 : 3
      });
    }
  }

  // 4. לוגיקת שיבוץ בסיסית
  DAY_COLUMNS.forEach((colIndex, dayIdx) => {
    let assignedThisDay = 0;

    for (let controller of controllers) {
      // בדיקת אילוצים:
      let currentVal = data[controller.rowIndex][colIndex] as string;
      
      // אם התא כבר מכיל X או שהבקר הגיע למכסה - דלג
      if (currentVal === "X" || currentVal === "x" || controller.assignedCount >= controller.maxShifts) {
        continue;
      }

      // הגדרת שעת משמרת (דוגמה)
      let shiftTime = "";
      if (dayIdx === 5) { // שישי
        shiftTime = "06:00-14:30";
      } else if (dayIdx === 6) { // מוצ"ש
        shiftTime = "19:30-23:30";
      } else { // ימי חול - חלוקה לבוקר/ערב
        shiftTime = (assignedThisDay % 2 === 0) ? "06:00-16:00" : "13:00-23:00";
      }

      // כתיבה לתא
      sheet.getCell(controller.rowIndex, colIndex).setValue(shiftTime);
      
      controller.assignedCount++;
      assignedThisDay++;
    }
  });

  console.log("השיבוץ הסתיים בהצלחה.");
}
