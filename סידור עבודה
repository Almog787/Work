/**
 * RedLine Strategic KPI Manager - V14.0 (Strict Mode Fixed)
 * ×¤×ª×¨×•×Ÿ ×©×’×™××•×ª ×¢×•×‘×™ ×§×•, ×˜×™×¤×•×¡×™ × ×ª×•× ×™× ×•××™××•×ª ××©×ª× ×™×
 */

// --- 1. ×”×’×“×¨×ª ××‘× ×™ ×”× ×ª×•× ×™× (Interfaces) ---
interface TaskDef {
  id: string;
  name: string;
  duration: number;
  category: string;
  targetMonthly: number;
  done: number;
}

interface Controller {
  name: string;
  start: string;
  end: string;
}

function main(workbook: ExcelScript.Workbook) {
  // 1. ×”×§××ª ×ª×©×ª×™×•×ª
  ensureMonthlyKPISTable(workbook);
  ensureControllersTable(workbook);
  setupViewControlSheet(workbook);

  // 2. ×§×¨×™××ª × ×ª×•× ×™×
  const monthlyTasks: TaskDef[] = readMonthlyKPIs(workbook);
  const controllers: Controller[] = readControllers(workbook);
  const viewSheet = workbook.getWorksheet("×‘×§×¨×ª_×ª×¦×•×’×”");
  const searchRange = viewSheet.getRange("B2");
  const searchTerm: string = (searchRange.getValue() as string || "").toLowerCase();

  // 3. ×”×›× ×ª ×’×™×œ×™×•×Ÿ ×¤×œ×˜
  let scheduleSheet = workbook.getWorksheet("×¡×™×“×•×¨_×©×‘×•×¢×™");
  if (!scheduleSheet) {
    scheduleSheet = workbook.addWorksheet("×¡×™×“×•×¨_×©×‘×•×¢×™");
  }
  
  let usedRange = scheduleSheet.getUsedRange();
  if (usedRange) {
    usedRange.clear();
  }

  const daysHeader: string[] = ["×¨××©×•×Ÿ", "×©× ×™", "×©×œ×™×©×™", "×¨×‘×™×¢×™", "×—××™×©×™", "×©×™×©×™", "××•×¦\"×©"];
  scheduleSheet.getRange("A1:H1").setValues([["×‘×§×¨", ...daysHeader]]);
  formatHeader(scheduleSheet.getRange("A1:H1"));

  // 4. ×œ×•×’×™×§×ª ×©×™×‘×•×¥ ×©×‘×•×¢×™
  let scheduleMatrix: string[][] = [];
  
  // ××™×•×Ÿ ×‘×§×¨×™×
  controllers.sort((a, b) => a.name.localeCompare(b.name));

  // ×©×›×¤×•×œ ×××’×¨ ×”××©×™××•×ª
  let currentMonthlyPool: TaskDef[] = [];
  for (let t of monthlyTasks) {
    currentMonthlyPool.push({...t});
  }

  for (let ctrl of controllers) {
    let row: string[] = [ctrl.name];

    for (let dIdx = 0; dIdx < 7; dIdx++) {
      let dailyPlan: string = generateDayPlan(ctrl, dIdx, currentMonthlyPool, searchTerm);
      row.push(dailyPlan);
    }
    scheduleMatrix.push(row);
  }

  // 5. ×›×ª×™×‘×ª ×ª×•×¦××•×ª
  if (scheduleMatrix.length > 0) {
    let range = scheduleSheet.getRangeByIndexes(1, 0, scheduleMatrix.length, 8);
    range.setValues(scheduleMatrix);
    formatOutputTable(scheduleSheet, range);
  }

  scheduleSheet.activate();
  console.log("×¡×™×“×•×¨ ×”×¢×‘×•×“×” ×”×©×‘×•×¢×™ × ×•×¦×¨ ×‘×”×¦×œ×—×”.");
}

/**
 * ×× ×•×¢ ×™×™×¦×•×¨ ×™×•× ×¢×‘×•×“×”
 */
function generateDayPlan(ctrl: Controller, dayIdx: number, taskPool: TaskDef[], search: string): string {
  let startStr: string = ctrl.start;
  let endStr: string = ctrl.end;
  
  if (dayIdx === 5) { startStr = "06:00"; endStr = "14:30"; }
  if (dayIdx === 6) { startStr = "19:00"; endStr = "24:00"; }

  let currentMin: number = timeToMin(startStr);
  let endMin: number = timeToMin(endStr);
  let planText: string = "";
  
  let visitedToday: Set<string> = new Set<string>();

  while (currentMin < endMin - 15) {
    const timeLeft: number = endMin - currentMin;

    let possibleTasks: TaskDef[] = taskPool
      .filter(t => t.duration <= timeLeft && !visitedToday.has(t.id))
      .sort((a, b) => (b.targetMonthly - b.done) - (a.targetMonthly - a.done));

    if (possibleTasks.length === 0) break;

    let selectedTask: TaskDef = possibleTasks[Math.floor(Math.random() * Math.min(3, possibleTasks.length))];
    
    selectedTask.done++;
    if (selectedTask.category === "STATION") {
      visitedToday.add(selectedTask.id);
    }

    let icon: string = getIcon(selectedTask.category);
    let line: string = `[${minToTime(currentMin)}] ${icon} ${selectedTask.name}`;
    
    if (search === "" || line.toLowerCase().indexOf(search) !== -1 || ctrl.name.toLowerCase().indexOf(search) !== -1) {
      planText += line + "\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n";
    }

    currentMin += selectedTask.duration;
  }
  return planText;
}

// --- ×¤×•× ×§×¦×™×•×ª ×ª×©×ª×™×ª ---

function ensureMonthlyKPISTable(workbook: ExcelScript.Workbook) {
  let sheet = workbook.getWorksheet("××¢×§×‘_×™×¢×“×™×_×—×•×“×©×™");
  if (!sheet) {
    sheet = workbook.addWorksheet("××¢×§×‘_×™×¢×“×™×_×—×•×“×©×™");
    let data: (string | number)[][] = [
      ["××–×”×”", "××©×™××”", "×§×˜×’×•×¨×™×”", "××©×š ×“×§'", "×™×¢×“ ×—×•×“×©×™", "×‘×•×¦×¢", "×™×ª×¨×”"]
    ];

    const stationsUG: string[] = ["××œ× ×‘×™", "×§×¨×œ×™×‘×š", "×™×”×•×“×™×ª", "×©××•×œ ×”××œ×š", "××¨×œ×•×–×•×¨×•×‘", "××‘× ×”×œ×œ", "×‘×™××œ×™×§", "×‘×Ÿ ×’×•×¨×™×•×Ÿ", "××”×¨×•× ×•×‘×™×¥", "×× ×”××•×©×‘×•×ª", "××œ×™×¤×œ×˜"];
    const stationsAG: string[] = ["×”×§×•×××™×•×ª", "×”×¢××œ", "×™×•×¡×¤×˜×œ", "×‘× ×™××™×Ÿ", "×‘×œ×¤×•×¨", "×–'×‘×•×˜×™× ×¡×§×™", "×¨×•×˜×©×™×œ×“", "×”×¢×¦×××•×ª", "××—×¨×•×–×ª", "×”×‘×¢×©\"×˜", "××™×¡×§×•×‘", "××¨×œ×™×š", "×‘×œ×•××¤×™×œ×“", "×©×œ××”", "×§×¨×™×ª ××¨×™×”", "×©× ×§×¨", "×©×—×", "×“× ×§× ×¨", "×§×¨×•×œ", "×¤×™× ×¡×§×¨", "×ª\"× ×¤\"×ª"];

    for (let s of stationsUG) { data.push([s, `×‘×§×¨×ª ×ª×—× ×” ${s}`, "STATION", 60, 20, 0, 20]); }
    for (let s of stationsAG) {
      let time: number = s === "×‘×œ×™× ×¡×•×Ÿ" ? 45 : 30;
      data.push([s, `×‘×§×¨×ª ×ª×—× ×” ${s}`, "STATION", time, 20, 0, 20]);
    }

    const hubs: string[] = ["××œ×™×¤×œ×˜", "×§×¨×™×ª ××¨×™×”", "×ª\"× ×¤\"×ª", "×”×§×•×××™×•×ª"];
    for (let h of hubs) { data.push([`KARON_${h}`, `×§×¨×•× ×•×ª - ${h}`, "KARON", 65, 96, 0, 96]); }

    for (let i = 1; i <= 21; i++) { data.push([`TRACK_${i}`, `××¡×™×œ×” ××§×˜×¢ ${i}`, "TRACK", 30, 4, 0, 4]); }

    data.push(["OB_R1", "××•× ×‘×•×¨×“ R1", "ONBOARD", 80, 360, 0, 360]);
    data.push(["OB_R3", "××•× ×‘×•×¨×“ R3", "ONBOARD", 45, 360, 0, 360]);

    let range = sheet.getRangeByIndexes(0, 0, data.length, 7);
    range.setValues(data);
    sheet.addTable(range, true).setName("MonthlyKPIs");
    
    sheet.getRangeByIndexes(1, 6, data.length - 1, 1).setFormula("=E2-F2");
    sheet.getUsedRange().getFormat().autofitColumns();
  }
}

function readMonthlyKPIs(workbook: ExcelScript.Workbook): TaskDef[] {
  let table = workbook.getTable("MonthlyKPIs");
  let vals: (string | number | boolean)[][] = table.getRangeBetweenHeaderAndTotal().getValues();
  return vals.map(r => ({
    id: r[0] as string,
    name: r[1] as string,
    category: r[2] as string,
    duration: Number(r[3]),
    targetMonthly: Number(r[4]),
    done: Number(r[5])
  }));
}

function ensureControllersTable(workbook: ExcelScript.Workbook) {
    if (!workbook.getWorksheet("×”×’×“×¨×•×ª_×‘×§×¨×™×")) {
        let sheet = workbook.addWorksheet("×”×’×“×¨×•×ª_×‘×§×¨×™×");
        let data: (string | number)[][] = [
            ["×©×", "×”×ª×—×œ×”", "×¡×™×•×"],
            ["××•×¨×™ ××™×™×–×œ×¨", "07:00", "16:00"], ["××™× ×” ×˜×™××•×¤×™×™×‘", "07:00", "16:00"],
            ["×“×•×“ ×¡×™×™×’", "07:00", "16:00"], ["×‘×ª×™×” ××‘×™×”", "09:00", "18:00"],
            ["×”×¨×¦×œ ×©×’×‘", "14:00", "23:00"], ["×™×•× ×™ ×™×•×¡×£", "14:00", "23:00"],
            ["×¢×¨×Ÿ × ×™×¦×Ÿ", "06:00", "15:00"], ["×¨×•×Ÿ ×˜×•×‘", "07:00", "16:00"]
        ];
        let range = sheet.getRangeByIndexes(0,0,data.length,3);
        range.setValues(data);
        sheet.addTable(range, true).setName("ControllersTable");
    }
}

function readControllers(workbook: ExcelScript.Workbook): Controller[] {
    let table = workbook.getTable("ControllersTable");
    let vals: (string | number | boolean)[][] = table.getRangeBetweenHeaderAndTotal().getValues();
    return vals.map(r => ({
        name: r[0] as string,
        start: convertTime(r[1]),
        end: convertTime(r[2])
    }));
}

function setupViewControlSheet(workbook: ExcelScript.Workbook) {
    let sheet = workbook.getWorksheet("×‘×§×¨×ª_×ª×¦×•×’×”");
    if (!sheet) {
        sheet = workbook.addWorksheet("×‘×§×¨×ª_×ª×¦×•×’×”");
        sheet.getRange("A2").setValue("×—×™×¤×•×© ×—×•×¤×©×™:");
        sheet.getRange("A2").getFormat().getFill().setColor("#334155");
        sheet.getRange("A2").getFormat().getFont().setColor("white");
        
        // ×ª×™×§×•×Ÿ ×©×’×™××ª thick: ×”×©×ª××©×ª×™ ×‘-continuous
        sheet.getRange("B2").getFormat().getRangeBorder(ExcelScript.BorderIndex.edgeBottom).setStyle(ExcelScript.BorderLineStyle.continuous);
        sheet.getRange("B2").getFormat().getRangeBorder(ExcelScript.BorderIndex.edgeBottom).setWeight(ExcelScript.BorderWeight.thick);
    }
}

// --- ×›×œ×™ ×¢×–×¨ ---

function timeToMin(t: string): number {
    if (!t) return 0;
    let p: string[] = t.split(":");
    return p.length < 2 ? 0 : parseInt(p[0]) * 60 + parseInt(p[1]);
}

function minToTime(m: number): string {
    let h: number = Math.floor(m / 60);
    let min: number = m % 60;
    return `${h.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`;
}

// ×ª×™×§×•×Ÿ ×©×’×™××ª Any: ×”×’×“×¨×ª ×¡×•×’ ××¤×•×¨×©×ª
function convertTime(v: string | number | boolean): string {
    if (typeof v === 'number') {
        let totalMins: number = Math.round(v * 24 * 60);
        return minToTime(totalMins);
    }
    return String(v);
}

function getIcon(cat: string): string {
    if (cat === "STATION") return "ğŸš‰";
    if (cat === "KARON") return "âš™ï¸";
    if (cat === "TRACK") return "ğŸ›¤ï¸";
    if (cat === "ONBOARD") return "ğŸš†";
    return "ğŸ“";
}

function formatHeader(r: ExcelScript.Range) {
    let format = r.getFormat();
    format.getFill().setColor("#0f172a");
    format.getFont().setColor("white");
    format.getFont().setBold(true);
    format.setHorizontalAlignment(ExcelScript.HorizontalAlignment.center);
}

function formatOutputTable(s: ExcelScript.Worksheet, r: ExcelScript.Range) {
    let format = r.getFormat();
    format.setWrapText(true);
    format.setVerticalAlignment(ExcelScript.VerticalAlignment.top);
    format.getFont().setSize(8);
    s.getRange("B:H").getFormat().setColumnWidth(160);
    s.getRange("A:A").getFormat().setColumnWidth(100);
}
