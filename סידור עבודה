/**
 * RedLine Strategic KPI Manager - V13.0
 * × ×™×”×•×œ ××©×™××•×ª ×—×•×“×©×™, ××›×™×¤×ª ×™×¢×“×™× ×•×©×™×‘×•×¥ ×©×‘×•×¢×™ ×—×›×
 */

interface TaskDef {
  id: string;
  name: string;
  duration: number;
  category: string;
  targetMonthly: number;
  done: number;
}

interface Controller {
  name: string;
  start: string;
  end: string;
}

function main(workbook: ExcelScript.Workbook) {
  // 1. ×”×§××ª ×ª×©×ª×™×•×ª
  ensureMonthlyKPISTable(workbook);
  ensureControllersTable(workbook);
  setupViewControlSheet(workbook);

  // 2. ×§×¨×™××ª × ×ª×•× ×™×
  const monthlyTasks = readMonthlyKPIs(workbook);
  const controllers = readControllers(workbook);
  const viewSheet = workbook.getWorksheet("×‘×§×¨×ª_×ª×¦×•×’×”");
  const searchTerm = (viewSheet.getRange("B2").getValue() as string || "").toLowerCase();

  // 3. ×”×›× ×ª ×’×™×œ×™×•×Ÿ ×¤×œ×˜
  let scheduleSheet = workbook.getWorksheet("×¡×™×“×•×¨_×©×‘×•×¢×™");
  if (!scheduleSheet) scheduleSheet = workbook.addWorksheet("×¡×™×“×•×¨_×©×‘×•×¢×™");
  scheduleSheet.getUsedRange()?.clear();

  const daysHeader = ["×¨××©×•×Ÿ", "×©× ×™", "×©×œ×™×©×™", "×¨×‘×™×¢×™", "×—××™×©×™", "×©×™×©×™", "××•×¦\"×©"];
  scheduleSheet.getRange("A1:H1").setValues([["×‘×§×¨", ...daysHeader]]);
  formatHeader(scheduleSheet.getRange("A1:H1"));

  // 4. ×œ×•×’×™×§×ª ×©×™×‘×•×¥ ×©×‘×•×¢×™
  // ×× ×• ×× ×”×œ×™× "××•× ×” ×™×•××™" ×›×“×™ ×œ×× ×•×¢ ×›×¤×œ ×‘×§×¨×•×ª ×‘×ª×—× ×” ××—×ª ×‘×™×•×
  let scheduleMatrix: string[][] = [];
  
  // ××™×•×Ÿ ×‘×§×¨×™× ×œ××—×™×“×•×ª
  controllers.sort((a, b) => a.name.localeCompare(b.name));

  // ×©×›×¤×•×œ ×××’×¨ ×”××©×™××•×ª ×œ×¦×•×¨×š ×—×™×©×•×‘ ×“×™× ××™
  let currentMonthlyPool = [...monthlyTasks];

  for (let ctrl of controllers) {
    let row: string[] = [ctrl.name];

    for (let dIdx = 0; dIdx < 7; dIdx++) {
      let dailyPlan = generateDayPlan(ctrl, dIdx, currentMonthlyPool, searchTerm);
      row.push(dailyPlan);
    }
    scheduleMatrix.push(row);
  }

  // 5. ×›×ª×™×‘×ª ×ª×•×¦××•×ª
  if (scheduleMatrix.length > 0) {
    let range = scheduleSheet.getRangeByIndexes(1, 0, scheduleMatrix.length, 8);
    range.setValues(scheduleMatrix);
    formatOutputTable(scheduleSheet, range);
  }

  scheduleSheet.activate();
  console.log("×¡×™×“×•×¨ ×”×¢×‘×•×“×” ×”×©×‘×•×¢×™ × ×•×¦×¨ ×¢×œ ×‘×¡×™×¡ ×”×™×¢×“×™× ×”×—×•×“×©×™×™×.");
}

/**
 * ×× ×•×¢ ×™×™×¦×•×¨ ×™×•× ×¢×‘×•×“×” ××‘×•×¡×¡ ×™×¢×“×™×
 */
function generateDayPlan(ctrl: Controller, dayIdx: number, taskPool: TaskDef[], search: string): string {
  let startStr = ctrl.start;
  let endStr = ctrl.end;
  
  // ×—×•×§×™ ×¡×•×¤"×©
  if (dayIdx === 5) { startStr = "06:00"; endStr = "14:30"; }
  if (dayIdx === 6) { startStr = "19:00"; endStr = "24:00"; }

  let currentMin = timeToMin(startStr);
  let endMin = timeToMin(endStr);
  let planText = "";
  
  // × ×™×”×•×œ ××©×™××•×ª ×©×‘×•×¦×¢×• ×”×™×•× (×›×“×™ ×œ×× ×•×¢ ×—×–×¨×” ×¢×œ ××•×ª×” ×ª×—× ×” ×‘××•×ª×• ×™×•× ×œ×‘×§×¨)
  let visitedToday = new Set<string>();

  while (currentMin < endMin - 15) {
    const timeLeft = endMin - currentMin;

    // ×¡×™× ×•×Ÿ ××©×™××•×ª ×¨×œ×•×•× ×˜×™×•×ª:
    // 1. × ×›× ×¡×•×ª ×‘×–××Ÿ ×©× ×©××¨
    // 2. ×”×‘×§×¨ ×œ× ×‘×™×§×¨ ×‘×”×Ÿ ×”×™×•×
    // 3. ×™×© ×¢×“×™×¤×•×ª ×œ××©×™××•×ª ×¢× ×”×™×ª×¨×” (Remainder) ×”×›×™ ×’×“×•×œ×”
    let possibleTasks = taskPool
      .filter(t => t.duration <= timeLeft && !visitedToday.has(t.id))
      .sort((a, b) => (b.targetMonthly - b.done) - (a.targetMonthly - a.done));

    if (possibleTasks.length === 0) break;

    // ×‘×—×™×¨×ª ×”××©×™××” ×”×›×™ ×“×—×•×¤×” (××—×ª ×-3 ×”×¨××©×•× ×•×ª ×œ×’×™×•×•×Ÿ)
    let selectedTask = possibleTasks[Math.floor(Math.random() * Math.min(3, possibleTasks.length))];
    
    // ×¡×™××•×Ÿ ×›×‘×•×¦×¢ (×œ×¦×•×¨×š ×”×¡×™××•×œ×¦×™×” ×”×©×‘×•×¢×™×ª)
    selectedTask.done++;
    if (selectedTask.category === "STATION") visitedToday.add(selectedTask.id);

    // ×¢×™×¦×•×‘ ×©×•×¨×”
    let icon = getIcon(selectedTask.category);
    let line = `[${minToTime(currentMin)}] ${icon} ${selectedTask.name}`;
    
    if (search === "" || line.toLowerCase().includes(search) || ctrl.name.toLowerCase().includes(search)) {
      planText += line + "\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n";
    }

    currentMin += selectedTask.duration;
  }
  return planText;
}

// --- ×¢×•×–×¨×™ × ×ª×•× ×™× ×•×ª×©×ª×™×•×ª ---

function ensureMonthlyKPISTable(workbook: ExcelScript.Workbook) {
  let sheet = workbook.getWorksheet("××¢×§×‘_×™×¢×“×™×_×—×•×“×©×™");
  if (!sheet) {
    sheet = workbook.addWorksheet("××¢×§×‘_×™×¢×“×™×_×—×•×“×©×™");
    let data: (string | number)[][] = [
      ["××–×”×”", "××©×™××”", "×§×˜×’×•×¨×™×”", "××©×š ×“×§'", "×™×¢×“ ×—×•×“×©×™", "×‘×•×¦×¢", "×™×ª×¨×”"]
    ];

    // ×”×•×¡×¤×ª 34 ×ª×—× ×•×ª (20 ×¤×¢××™× ×‘×—×•×“×©)
    const stationsUG = ["××œ× ×‘×™", "×§×¨×œ×™×‘×š", "×™×”×•×“×™×ª", "×©××•×œ ×”××œ×š", "××¨×œ×•×–×•×¨×•×‘", "××‘× ×”×œ×œ", "×‘×™××œ×™×§", "×‘×Ÿ ×’×•×¨×™×•×Ÿ", "××”×¨×•× ×•×‘×™×¥", "×× ×”××•×©×‘×•×ª", "××œ×™×¤×œ×˜"];
    const stationsAG = ["×”×§×•×××™×•×ª", "×”×¢××œ", "×™×•×¡×¤×˜×œ", "×‘× ×™××™×Ÿ", "×‘×œ×¤×•×¨", "×–'×‘×•×˜×™× ×¡×§×™", "×¨×•×˜×©×™×œ×“", "×”×¢×¦×××•×ª", "××—×¨×•×–×ª", "×”×‘×¢×©\"×˜", "××™×¡×§×•×‘", "××¨×œ×™×š", "×‘×œ×•××¤×™×œ×“", "×©×œ××”", "×§×¨×™×ª ××¨×™×”", "×©× ×§×¨", "×©×—×", "×“× ×§× ×¨", "×§×¨×•×œ", "×¤×™× ×¡×§×¨", "×ª\"× ×¤\"×ª"];

    stationsUG.forEach(s => data.push([s, `×‘×§×¨×ª ×ª×—× ×” ${s}`, "STATION", 60, 20, 0, 20]));
    stationsAG.forEach(s => {
        let time = s === "×‘×œ×™× ×¡×•×Ÿ" ? 45 : 30;
        data.push([s, `×‘×§×¨×ª ×ª×—× ×” ${s}`, "STATION", time, 20, 0, 20]);
    });

    // ×§×¨×•× ×•×ª (4 ×©×¢×•×ª ×‘×™×•× ×œ×›×œ ×ª×—× ×ª ×§×¦×” - ×™×¢×“ ×—×•×“×©×™ ××—×•×©×‘)
    const hubs = ["××œ×™×¤×œ×˜", "×§×¨×™×ª ××¨×™×”", "×ª\"× ×¤\"×ª", "×”×§×•×××™×•×ª"];
    hubs.forEach(h => data.push([`KARON_${h}`, `×§×¨×•× ×•×ª - ${h}`, "KARON", 65, 96, 0, 96]));

    // ××¡×™×œ×•×ª (4 ×¤×¢××™× ×‘×—×•×“×© ×œ×›×œ ××§×˜×¢)
    for(let i=1; i<=21; i++) data.push([`TRACK_${i}`, `××¡×™×œ×” ××§×˜×¢ ${i}`, "TRACK", 30, 4, 0, 4]);

    // ××•× ×‘×•×¨×“
    data.push(["OB_R1", "××•× ×‘×•×¨×“ R1", "ONBOARD", 80, 360, 0, 360]);
    data.push(["OB_R3", "××•× ×‘×•×¨×“ R3", "ONBOARD", 45, 360, 0, 360]);

    let range = sheet.getRangeByIndexes(0, 0, data.length, 7);
    range.setValues(data);
    sheet.addTable(range, true).setName("MonthlyKPIs");
    
    // × ×•×¡×—×ª ×™×ª×¨×”
    sheet.getRange("G2:G500").setFormula("=E2-F2");
    sheet.getUsedRange().getFormat().autofitColumns();
  }
}

function readMonthlyKPIs(workbook: ExcelScript.Workbook): TaskDef[] {
  let table = workbook.getTable("MonthlyKPIs");
  let vals = table.getRangeBetweenHeaderAndTotal().getValues();
  return vals.map(r => ({
    id: r[0] as string,
    name: r[1] as string,
    category: r[2] as string,
    duration: Number(r[3]),
    targetMonthly: Number(r[4]),
    done: Number(r[5])
  }));
}

function ensureControllersTable(workbook: ExcelScript.Workbook) {
    if (!workbook.getWorksheet("×”×’×“×¨×•×ª_×‘×§×¨×™×")) {
        let sheet = workbook.addWorksheet("×”×’×“×¨×•×ª_×‘×§×¨×™×");
        let data = [
            ["×©×", "×”×ª×—×œ×”", "×¡×™×•×"],
            ["××•×¨×™ ××™×™×–×œ×¨", "07:00", "16:00"], ["××™× ×” ×˜×™××•×¤×™×™×‘", "07:00", "16:00"],
            ["×“×•×“ ×¡×™×™×’", "07:00", "16:00"], ["×‘×ª×™×” ××‘×™×”", "09:00", "18:00"],
            ["×”×¨×¦×œ ×©×’×‘", "14:00", "23:00"], ["×™×•× ×™ ×™×•×¡×£", "14:00", "23:00"],
            ["×¢×¨×Ÿ × ×™×¦×Ÿ", "06:00", "15:00"], ["×¨×•×Ÿ ×˜×•×‘", "07:00", "16:00"]
        ];
        let range = sheet.getRangeByIndexes(0,0,data.length,3);
        range.setValues(data);
        sheet.addTable(range, true).setName("ControllersTable");
    }
}

function readControllers(workbook: ExcelScript.Workbook): Controller[] {
    let vals = workbook.getTable("ControllersTable").getRangeBetweenHeaderAndTotal().getValues();
    return vals.map(r => ({
        name: r[0] as string,
        start: convertTime(r[1]),
        end: convertTime(r[2])
    }));
}

function setupViewControlSheet(workbook: ExcelScript.Workbook) {
    if (!workbook.getWorksheet("×‘×§×¨×ª_×ª×¦×•×’×”")) {
        let sheet = workbook.addWorksheet("×‘×§×¨×ª_×ª×¦×•×’×”");
        sheet.getRange("A2").setValue("×—×™×¤×•×© ×—×•×¤×©×™:");
        sheet.getRange("A2:A2").getFormat().getFill().setColor("#334155");
        sheet.getRange("A2:A2").getFormat().getFont().setColor("white");
        sheet.getRange("B2").getFormat().getRangeBorder(ExcelScript.BorderIndex.edgeBottom).setStyle(ExcelScript.BorderLineStyle.thick);
    }
}

// --- ×›×œ×™ ×¢×–×¨ ---

function timeToMin(t: string): number {
    let p = t.split(":");
    return p.length < 2 ? 0 : parseInt(p[0]) * 60 + parseInt(p[1]);
}

function minToTime(m: number): string {
    return `${Math.floor(m/60).toString().padStart(2,'0')}:${(m%60).toString().padStart(2,'0')}`;
}

function convertTime(v: any): string {
    if (typeof v === 'number') return minToTime(Math.round(v * 24 * 60));
    return String(v);
}

function getIcon(cat: string): string {
    switch(cat) {
        case "STATION": return "ğŸš‰";
        case "KARON": return "âš™ï¸";
        case "TRACK": return "ğŸ›¤ï¸";
        case "ONBOARD": return "ğŸš†";
        default: return "ğŸ“";
    }
}

function formatHeader(r: ExcelScript.Range) {
    r.getFormat().getFill().setColor("#0f172a");
    r.getFormat().getFont().setColor("white");
    r.getFormat().getFont().setBold(true);
    r.getFormat().setHorizontalAlignment(ExcelScript.HorizontalAlignment.center);
}

function formatOutputTable(s: ExcelScript.Worksheet, r: ExcelScript.Range) {
    r.getFormat().setWrapText(true);
    r.getFormat().setVerticalAlignment(ExcelScript.VerticalAlignment.top);
    r.getFormat().getFont().setSize(8);
    s.getRange("B:H").getFormat().setColumnWidth(160);
    s.getRange("A:A").getFormat().setColumnWidth(100);
}
