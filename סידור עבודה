/**
 * מערכת סידור עבודה אסטרטגי - רכבת קלה (V8.0 Excel Edition)
 * כולל הקמת גיליונות עזר, אימות נתונים (Dropdowns) ולוגיקת שיבוץ מתקדמת.
 */

// הגדרת טיפוסים למבני הנתונים
interface TaskDef {
  name: string;
  duration: number;
  type: string;
  category: string;
}

interface ControllerDef {
  name: string;
  start: string;
  end: string;
}

function main(workbook: ExcelScript.Workbook) {
  // 1. הקמת תשתיות (אם לא קיימות)
  let tasksTable = await ensureSetupSheet(workbook, "הגדרות_משימות", getTaskDefaults());
  let controllersTable = await ensureSetupSheet(workbook, "הגדרות_בקרים", getControllerDefaults());
  let stationsTable = await ensureSetupSheet(workbook, "הגדרות_תחנות", getStationDefaults());

  // 2. קריאת הנתונים העדכניים מהטבלאות (למקרה שהמשתמש שינה משהו)
  const taskDefs = readTasksFromTable(workbook, "הגדרות_משימות");
  const controllers = readControllersFromTable(workbook, "הגדרות_בקרים");
  const stationList = readStationsFromTable(workbook, "הגדרות_תחנות");

  // 3. הכנת גיליון הפלט
  let outputSheet = workbook.getWorksheet("סידור_שבועי");
  if (!outputSheet) {
    outputSheet = workbook.addWorksheet("סידור_שבועי");
  }
  outputSheet.getUsedRange()?.clear(); // ניקוי ישן

  // כותרות הטבלה
  const headers = [["שם הבקר", "ראשון", "שני", "שלישי", "רביעי", "חמישי", "שישי", "מוצ\"ש"]];
  const headerRange = outputSheet.getRange("A1:H1");
  headerRange.setValues(headers);
  headerRange.getFormat().getFill().setColor("#1e293b"); // כחול כהה
  headerRange.getFormat().getFont().setColor("white");
  headerRange.getFormat().getFont().setBold(true);

  // 4. לוגיקת השיבוץ (The Scheduler Engine)
  let scheduleMatrix: string[][] = [];

  // מעבר על כל בקר (שורות)
  for (let ctrl of controllers) {
    let row: string[] = [ctrl.name];

    // מעבר על כל יום (עמודות)
    for (let day = 0; day < 7; day++) {
      // ניהול מאגר תחנות פנויות יומי (כדי למנוע כפילות תחנה ביום)
      // הערה: בגלל שאקסל רץ טורית, כל בקר "תופס" תחנות לבאים אחריו
      // בסימולציה מלאה היינו צריכים לנהל סטייט גלובלי ליום, כאן נעשה לוגיקה מקומית משופרת
      
      let dayContent = generateDaySchedule(ctrl, day, taskDefs, stationList);
      row.push(dayContent);
    }
    scheduleMatrix.push(row);
  }

  // 5. כתיבת התוצאות
  if (scheduleMatrix.length > 0) {
    let range = outputSheet.getRangeByIndexes(1, 0, scheduleMatrix.length, 8);
    range.setValues(scheduleMatrix);
    
    // עיצוב התאים
    range.getFormat().setWrapText(true); // גלישת טקסט
    range.getFormat().setVerticalAlignment(ExcelScript.VerticalAlignment.top);
    outputSheet.getRange("B:H").getFormat().setColumnWidth(180); // רוחב עמודה
    outputSheet.getRange("A:A").getFormat().setColumnWidth(100);
    
    // הוספת גבולות
    range.getFormat().getRangeBorder("InsideHorizontal").setStyle(ExcelScript.BorderLineStyle.continuous);
    range.getFormat().getRangeBorder("InsideVertical").setStyle(ExcelScript.BorderLineStyle.continuous);
  }

  console.log("הסידור נוצר בהצלחה!");
}

/**
 * מנוע יצירת הלו"ז ליום בודד
 */
function generateDaySchedule(ctrl: ControllerDef, dayIdx: number, tasks: TaskDef[], stations: string[]): string {
  // התאמת שעות לפי חוקי סופ"ש
  let startStr = ctrl.start;
  let endStr = ctrl.end;
  
  if (dayIdx === 5) { startStr = "06:00"; endStr = "14:30"; } // שישי
  if (dayIdx === 6) { startStr = "19:00"; endStr = "24:00"; } // מוצ"ש

  let currentMin = timeToMin(startStr);
  let endMin = timeToMin(endStr);
  
  let scheduleText = "";
  
  // יצירת מאגר משימות זמין ליום הזה (Backlog)
  // מעתיקים את רשימת המשימות ומערבבים
  let availableTasks = [...tasks].sort(() => Math.random() - 0.5);
  
  while (currentMin < endMin - 15) {
    const timeLeft = endMin - currentMin;
    
    // בחירת משימה שמתאימה לזמן שנותר
    let selectedTask: TaskDef | null = null;
    
    // לוגיקת בחירה פשוטה אך חכמה
    for (let t of availableTasks) {
      if (t.duration <= timeLeft) {
        selectedTask = t;
        break;
      }
    }

    if (!selectedTask) break; // אין משימות מתאימות לזמן שנותר

    // יצירת פרטים (שם תחנה וכו')
    let detail = "";
    if (selectedTask.category === "STATION") {
      detail = stations[Math.floor(Math.random() * stations.length)];
    } else if (selectedTask.category === "TRACK") {
      detail = "מקטע " + Math.floor(Math.random() * 21);
    }

    // הוספה לטקסט התא
    let startTime = minToTime(currentMin);
    currentMin += selectedTask.duration;
    // let endTime = minToTime(currentMin); // אופציונלי להציג שעת סיום

    scheduleText += `${startTime} ${selectedTask.name} ${detail}\n`;
  }

  return scheduleText;
}

// --- פונקציות עזר להקמת גיליונות ונתונים ---

async function ensureSetupSheet(workbook: ExcelScript.Workbook, sheetName: string, defaultData: (string | number)[][]) {
  let sheet = workbook.getWorksheet(sheetName);
  
  if (!sheet) {
    sheet = workbook.addWorksheet(sheetName);
    
    // כתיבת נתונים
    let range = sheet.getRangeByIndexes(0, 0, defaultData.length, defaultData[0].length);
    range.setValues(defaultData);
    
    // יצירת טבלה
    let table = workbook.addTable(range, true);
    table.setName(sheetName + "_Table");
    
    // עיצוב כותרת
    sheet.getRange("A1:Z1").getFormat().getFill().setColor("#4472C4");
    sheet.getRange("A1:Z1").getFormat().getFont().setColor("white");
    sheet.getUsedRange().getFormat().autofitColumns();

    // --- הוספת Dropdowns (Data Validation) ---
    
    if (sheetName === "הגדרות_משימות") {
      // עמודה C (קטגוריה): רשימה סגורה
      let catRange = sheet.getRange("C2:C100");
      let dataValidation = catRange.getDataValidation();
      dataValidation.setRule({
        list: {
          inCellDropDown: true,
          source: "STATION,TRACK,ONBOARD,KARON,SERVICE"
        }
      });
    }

    if (sheetName === "הגדרות_בקרים") {
        // עמודה B, C (שעות): אפשר להוסיף ולידציה של שעות אם רוצים, אבל כאן נשאיר טקסט
    }
  }
  return workbook.getTable(sheetName + "_Table");
}

// --- פונקציות המרת זמן ---
function timeToMin(t: string): number {
  if (!t) return 0;
  let parts = t.split(":");
  return parseInt(parts[0]) * 60 + parseInt(parts[1]);
}

function minToTime(mins: number): string {
  let h = Math.floor(mins / 60);
  let m = mins % 60;
  return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
}

// --- קריאת נתונים מהטבלאות ---
function readTasksFromTable(workbook: ExcelScript.Workbook, sheetName: string): TaskDef[] {
  let table = workbook.getTable(sheetName + "_Table");
  if (!table) return getTaskDefaultsObj(); // Fallback
  
  let range = table.getRangeBetweenHeaderAndTotal();
  let values = range.getValues();
  
  let tasks: TaskDef[] = [];
  // מניחים מבנה: שם, משך, קטגוריה
  for (let row of values) {
    tasks.push({
      name: row[0] as string,
      duration: Number(row[1]),
      category: row[2] as string,
      type: row[2] as string // Duplicate for compatibility
    });
  }
  return tasks;
}

function readControllersFromTable(workbook: ExcelScript.Workbook, sheetName: string): ControllerDef[] {
  let table = workbook.getTable(sheetName + "_Table");
  if (!table) return []; 
  let values = table.getRangeBetweenHeaderAndTotal().getValues();
  return values.map(row => ({
    name: row[0] as string,
    start: convertExcelTime(row[1]),
    end: convertExcelTime(row[2])
  }));
}

function readStationsFromTable(workbook: ExcelScript.Workbook, sheetName: string): string[] {
  let table = workbook.getTable(sheetName + "_Table");
  if (!table) return [];
  let values = table.getRangeBetweenHeaderAndTotal().getValues();
  // מניחים עמודה A היא שם התחנה
  return values.map(row => row[0] as string);
}

// המרת זמן אקסל (שבר עשרוני) למחרוזת HH:MM
function convertExcelTime(val: any): string {
  if (typeof val === 'string') return val;
  if (typeof val === 'number') {
    let totalMins = Math.round(val * 24 * 60);
    return minToTime(totalMins);
  }
  return "00:00";
}


// --- נתוני ברירת מחדל (Hardcoded Defaults) ---

function getTaskDefaults(): (string | number)[][] {
  return [
    ["שם המשימה", "משך (דקות)", "קטגוריה (בחר מהרשימה)"],
    ["בקרת תחנה תת\"ק", 60, "STATION"],
    ["בקרת תחנה עילית", 30, "STATION"],
    ["בקרת תחנה (בלינסון)", 45, "STATION"],
    ["בקרת קרונות", 65, "KARON"],
    ["אונבורד R1", 80, "ONBOARD"],
    ["אונבורד R3", 45, "ONBOARD"],
    ["ניקיון מסילה", 30, "TRACK"],
    ["בקרת מסלול", 80, "TRACK"],
    ["מרכז שירות", 15, "SERVICE"],
    ["מוקד", 15, "SERVICE"]
  ];
}

// משמש כ-Fallback אם הטבלה לא קיימת
function getTaskDefaultsObj(): TaskDef[] {
    return [
        { name: "תחנה תת\"ק", duration: 60, type: "STATION", category: "STATION" },
        { name: "תחנה עילית", duration: 30, type: "STATION", category: "STATION" },
        { name: "קרונות", duration: 65, type: "KARON", category: "KARON" },
        { name: "אונבורד", duration: 60, type: "ONBOARD", category: "ONBOARD" }
    ];
}

function getControllerDefaults(): (string | number)[][] {
  return [
    ["שם הבקר", "התחלה ברירת מחדל", "סיום ברירת מחדל"],
    ["אורי מייזלר", "07:00", "16:00"],
    ["אינה טימופייב", "07:00", "16:00"],
    ["אלתי קראו", "08:00", "17:00"],
    ["בוריס דולציגר", "06:00", "15:00"],
    ["בתיה אביה", "09:00", "18:00"],
    ["דוד סייג", "07:00", "16:00"],
    ["הרצל שגב", "14:00", "23:00"],
    ["יוני יוסף", "14:00", "23:00"],
    ["משה אליהו", "15:00", "23:00"],
    ["ערן ניצן", "06:00", "15:00"],
    ["רון טוב", "07:00", "16:00"],
    ["אברהם גברילביץ'", "08:00", "17:00"]
  ];
}

function getStationDefaults(): (string | number)[][] {
  return [
    ["שם התחנה", "סוג"],
    ["אלנבי", "UG"], ["קרליבך", "UG"], ["יהודית", "UG"], ["שאול המלך", "UG"], ["ארלוזורוב", "UG"],
    ["הקוממיות", "AG"], ["העמל", "AG"], ["כ\"ט בנובמבר", "AG"], ["יוספטל", "AG"], ["בלפור", "AG"],
    ["בלינסון", "AG"], ["ת\"מ פ\"ת", "AG"], ["קרית אריה", "AG"]
  ];
}
