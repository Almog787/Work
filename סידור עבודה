/**
 * RedLine OS V19.0 - Master Strategic Scheduler (Strict Type Fixed)
 * פתרון שגיאות ה-Inference וה-Explicit Any.
 */

// --- הגדרת מבני הנתונים (Interfaces) ---

interface Station {
  name: string;
  type: string;
  duration: number;
  isHub: boolean;
}

interface MonthlyKPI {
  id: string;
  target: number;
  done: number;
}

interface Controller {
  name: string;
  start: string;
  end: string;
}

function main(workbook: ExcelScript.Workbook) {
  // 1. הקמת תשתיות (לוח בקרה, יעדים, בקרים)
  setupInfrastructure(workbook);

  // 2. קריאת הגדרות מלוח הבקרה
  const dashSheet: ExcelScript.Worksheet = workbook.getWorksheet("לוח_בקרה");
  const startDateValue: number = dashSheet.getRange("B2").getValue() as number;
  const shouldSync: boolean = dashSheet.getRange("B3").getValue() === "כן";
  
  if (!startDateValue) {
    console.log("נא להזין תאריך תחילת שבוע בתא B2 בגיליון לוח_בקרה");
    return;
  }

  // המרת תאריך אקסל לתאריך JavaScript
  const startDate: Date = new Date(Math.round((startDateValue - 25569) * 86400 * 1000));
  
  // 3. קריאת המצב החודשי מהטבלה
  const kpiTable: ExcelScript.Table = workbook.getTable("Monthly_KPIs_Table");
  const kpiValues: (string | number | boolean)[][] = kpiTable.getRangeBetweenHeaderAndTotal().getValues();
  const kpiMap: Map<string, MonthlyKPI> = new Map();
  
  kpiValues.forEach((row: (string | number | boolean)[]) => {
    kpiMap.set(row[0] as string, { 
      id: row[0] as string, 
      target: Number(row[2]), 
      done: Number(row[3]) 
    });
  });

  // 4. קריאת נתוני בקרים ורשימת תחנות
  const controllers: Controller[] = readControllers(workbook);
  const stationsDB: Station[] = getFullStationsDB();

  // 5. הכנת גיליון הסידור השבועי
  let scheduleSheet: ExcelScript.Worksheet = workbook.getWorksheet("סידור_שבועי");
  if (!scheduleSheet) scheduleSheet = workbook.addWorksheet("סידור_שבועי");
  
  const usedRange: ExcelScript.Range = scheduleSheet.getUsedRange();
  if (usedRange) usedRange.clear();

  // יצירת כותרות עם תאריכים
  let dateHeaders: string[] = ["בקר"];
  for (let i = 0; i < 7; i++) {
    let d: Date = new Date(startDate);
    d.setDate(d.getDate() + i);
    dateHeaders.push(`${getDayName(i)} (${d.getDate()}/${d.getMonth() + 1})`);
  }
  scheduleSheet.getRange("A1:H1").setValues([dateHeaders]);
  formatHeader(scheduleSheet.getRange("A1:H1"));

  // 6. מנוע שיבוץ אסטרטגי
  let scheduleMatrix: string[][] = [];
  let currentSessionAssignments: Map<string, number> = new Map(); // מה שובץ בהרצה הזו

  for (let ctrl of controllers) {
    let row: string[] = [ctrl.name];
    for (let dayIdx = 0; dayIdx < 7; dayIdx++) {
      let dailyPlan: string = generateStrategicDay(ctrl, dayIdx, stationsDB, kpiMap, currentSessionAssignments);
      row.push(dailyPlan);
    }
    scheduleMatrix.push(row);
  }

  // 7. כתיבת התוצאות לגיליון
  if (scheduleMatrix.length > 0) {
    const dataRange: ExcelScript.Range = scheduleSheet.getRangeByIndexes(1, 0, scheduleMatrix.length, 8);
    dataRange.setValues(scheduleMatrix);
    formatOutputTable(scheduleSheet, dataRange);
  }

  // 8. סנכרון חודשי (רק אם המשתמש אישר בלוח הבקרה)
  if (shouldSync) {
    const updatedKPIs: (string | number | boolean)[][] = kpiValues.map((row: (string | number | boolean)[]) => {
      let id: string = row[0] as string;
      if (currentSessionAssignments.has(id)) {
        row[3] = Number(row[3]) + currentSessionAssignments.get(id)!;
      }
      return row;
    });
    kpiTable.getRangeBetweenHeaderAndTotal().setValues(updatedKPIs);
    dashSheet.getRange("B5").setValue("סונכרן בהצלחה בתאריך: " + new Date().toLocaleString());
  } else {
    dashSheet.getRange("B5").setValue("תצוגה מקדימה בלבד - לא בוצע סנכרון");
  }

  scheduleSheet.activate();
}

/**
 * מנוע שיבוץ מבוסס עדיפות לפי יתרה ב-KPI
 */
function generateStrategicDay(ctrl: Controller, dayIdx: number, stations: Station[], kpiMap: Map<string, MonthlyKPI>, sessionTracker: Map<string, number>): string {
  let startMin: number = timeToMin(ctrl.start);
  let endMin: number = timeToMin(ctrl.end);
  
  // חוקי סופ"ש
  if (dayIdx === 5) { startMin = timeToMin("06:00"); endMin = timeToMin("14:30"); }
  if (dayIdx === 6) { startMin = timeToMin("19:00"); endMin = timeToMin("24:00"); }

  let currentMin: number = startMin;
  let planText: string = "";
  let visitedToday: Set<string> = new Set<string>();

  while (currentMin < endMin - 20) {
    let timeLeft: number = endMin - currentMin;
    
    // מציאת המשימה עם הפיגור הגדול ביותר ביעדים
    let possibleStations: Station[] = stations.filter(s => s.duration <= timeLeft && !visitedToday.has(s.name));
    
    // מיון לפי יתרה חסרה (Target - Done)
    possibleStations.sort((a, b) => {
        let remA: number = (kpiMap.get(a.name)?.target || 0) - (kpiMap.get(a.name)?.done || 0);
        let remB: number = (kpiMap.get(b.name)?.target || 0) - (kpiMap.get(b.name)?.done || 0);
        return remB - remA;
    });

    let bestTask: Station | undefined = possibleStations[0];

    if (bestTask) {
      planText += `[${minToTime(currentMin)}] ${bestTask.name}\n────────────\n`;
      visitedToday.add(bestTask.name);
      
      // רישום לצורך סנכרון סופי
      sessionTracker.set(bestTask.name, (sessionTracker.get(bestTask.name) || 0) + 1);
      currentMin += bestTask.duration;
    } else {
      planText += `[${minToTime(currentMin)}] אונבורד / נסיעה\n────────────\n`;
      currentMin += 45;
    }
  }
  return planText;
}

// --- פונקציות תשתית וקריאת טבלאות ---

function readControllers(workbook: ExcelScript.Workbook): Controller[] {
  const table: ExcelScript.Table = workbook.getTable("ControllersTbl");
  if (!table) return [];
  
  const values: (string | number | boolean)[][] = table.getRangeBetweenHeaderAndTotal().getValues();
  return values.map((row: (string | number | boolean)[]) => ({
    name: String(row[0]),
    start: convertExcelTimeFormat(row[1]),
    end: convertExcelTimeFormat(row[2])
  }));
}

function setupInfrastructure(workbook: ExcelScript.Workbook) {
  // 1. לוח בקרה
  let dash: ExcelScript.Worksheet = workbook.getWorksheet("לוח_בקרה");
  if (!dash) {
    dash = workbook.addWorksheet("לוח_בקרה");
    dash.getRange("A2:A3").setValues([["תאריך תחילת שבוע (יום א'):"], ["סנכרון ליעדים חודשיים?"]]);
    dash.getRange("B3").getDataValidation().setRule({ list: { inCellDropDown: true, source: "כן,לא" } });
    dash.getRange("B2").setValue(46050); // 02/02/2026 כברירת מחדל
    dash.getRange("B3").setValue("לא");
    dash.getRange("A2:A3").getFormat().getFont().setBold(true);
    dash.getUsedRange().getFormat().autofitColumns();
  }

  // 2. טבלת יעדים
  if (!workbook.getWorksheet("מעקב_יעדים_חודשי")) {
    const sheet: ExcelScript.Worksheet = workbook.addWorksheet("מעקב_יעדים_חודשי");
    let data: (string | number)[][] = [["משימה", "סוג", "יעד", "בוצע", "יתרה"]];
    getFullStationsDB().forEach((s: Station) => data.push([s.name, s.type, 20, 0, 20]));
    sheet.getRangeByIndexes(0, 0, data.length, 5).setValues(data);
    sheet.addTable(sheet.getRangeByIndexes(0, 0, data.length, 5), true).setName("Monthly_KPIs_Table");
    sheet.getRangeByIndexes(1, 4, data.length - 1, 1).setFormula("=C2-D2");
    sheet.getUsedRange().getFormat().autofitColumns();
  }

  // 3. הגדרות בקרים
  if (!workbook.getWorksheet("הגדרות_בקרים")) {
    const sheet: ExcelScript.Worksheet = workbook.addWorksheet("הגדרות_בקרים");
    let data: (string | number)[][] = [
      ["שם", "התחלה", "סיום"],
      ["אורי מייזלר", "07:00", "16:00"],
      ["אינה טימופייב", "07:00", "16:00"],
      ["בתיה אביה", "09:00", "18:00"],
      ["הרצל שגב", "14:00", "23:00"]
    ];
    sheet.getRangeByIndexes(0, 0, data.length, 3).setValues(data);
    sheet.addTable(sheet.getRangeByIndexes(0, 0, data.length, 3), true).setName("ControllersTbl");
  }
}

// --- נתונים ופונקציות עזר ---

function getFullStationsDB(): Station[] {
  return [
    { name: "אלנבי", type: "UG", duration: 60, isHub: false },
    { name: "קרליבך", type: "UG", duration: 60, isHub: false },
    { name: "יהודית", type: "UG", duration: 60, isHub: false },
    { name: "שאול המלך", type: "UG", duration: 60, isHub: false },
    { name: "יוספטל", type: "AG", duration: 30, isHub: false },
    { name: "קוממיות", type: "AG", duration: 30, isHub: true },
    { name: "אליפלט", type: "AG", duration: 60, isHub: true },
    { name: "ת\"מ פ\"ת", type: "AG", duration: 30, isHub: true }
  ];
}

function timeToMin(t: string): number {
    if (!t || t.indexOf(":") === -1) return 0;
    let parts: string[] = t.split(":");
    return Number(parts[0]) * 60 + Number(parts[1]);
}

function minToTime(m: number): string {
    return `${Math.floor(m / 60).toString().padStart(2, '0')}:${(m % 60).toString().padStart(2, '0')}`;
}

function convertExcelTimeFormat(v: string | number | boolean): string {
    if (typeof v === 'number') {
        let totalMins: number = Math.round(v * 24 * 60);
        return minToTime(totalMins);
    }
    return String(v);
}

function getDayName(i: number): string {
  return ["ראשון", "שני", "שלישי", "רביעי", "חמישי", "שישי", "מוצ\"ש"][i];
}

function formatHeader(r: ExcelScript.Range) {
    let fmt: ExcelScript.RangeFormat = r.getFormat();
    fmt.getFill().setColor("#0f172a");
    fmt.getFont().setColor("white");
    fmt.getFont().setBold(true);
    fmt.setHorizontalAlignment(ExcelScript.HorizontalAlignment.center);
}

function formatOutputTable(s: ExcelScript.Worksheet, r: ExcelScript.Range) {
    let fmt: ExcelScript.RangeFormat = r.getFormat();
    fmt.setWrapText(true);
    fmt.setVerticalAlignment(ExcelScript.VerticalAlignment.top);
    fmt.getFont().setSize(8);
    s.getRange("B:H").getFormat().setColumnWidth(160);
    s.getRange("A:A").getFormat().setColumnWidth(100);
}
