/**
 * RedLine Master Scheduler V15.1 - Fixed Version
 * ×¤×ª×¨×•×Ÿ ×©×’×™××•×ª Strict Mode, Any ×•-Arrow Functions
 */

interface Station {
  id: number;
  name: string;
  type: string;
  controlMin: number;
  stayMin: number;
  isHub: boolean;
}

interface Task {
  name: string;
  category: string;
  duration: number;
  detail: string;
}

interface Controller {
  name: string;
  start: string;
  end: string;
}

interface GlobalWeeklyTracker {
  stations: Set<string>;
  karonDailyHours: number;
  trackCount: number;
}

function main(workbook: ExcelScript.Workbook) {
  // 1. ×”×§××ª ×’×™×œ×™×•× ×•×ª ×¢×–×¨
  setupReferenceData(workbook);

  // 2. ×§×¨×™××ª × ×ª×•× ×™×
  const stations: Station[] = getStationsDB();
  const controllers: Controller[] = readControllers(workbook);

  // 3. ×”×›× ×ª ×’×™×œ×™×•×Ÿ ×¤×œ×˜
  let outputSheet = workbook.getWorksheet("×¡×™×“×•×¨_×¢×‘×•×“×”_×©×‘×•×¢×™");
  if (!outputSheet) {
    outputSheet = workbook.addWorksheet("×¡×™×“×•×¨_×¢×‘×•×“×”_×©×‘×•×¢×™");
  }
  let usedRange = outputSheet.getUsedRange();
  if (usedRange) {
    usedRange.clear();
  }

  const days: string[] = ["×¨××©×•×Ÿ", "×©× ×™", "×©×œ×™×©×™", "×¨×‘×™×¢×™", "×—××™×©×™", "×©×™×©×™", "××•×¦\"×©"];
  outputSheet.getRange("A1:H1").setValues([["×‘×§×¨", ...days]]);
  formatHeader(outputSheet.getRange("A1:H1"));

  // 4. ×× ×•×¢ ×©×™×‘×•×¥
  let matrix: string[][] = [];
  
  // ×ª×™×§×•×Ÿ ×©×•×¨×” 83: ×”×’×“×¨×” ××¤×•×¨×©×ª ×©×œ ×”×˜×™×¤×•×¡
  let globalWeeklyTracker: GlobalWeeklyTracker = {
    stations: new Set<string>(),
    karonDailyHours: 0,
    trackCount: 0
  };

  for (let ctrl of controllers) {
    let row: string[] = [ctrl.name];
    for (let dIdx = 0; dIdx < 7; dIdx++) {
      let dailyPlan = generateDayPlan(ctrl, dIdx, stations, globalWeeklyTracker);
      row.push(dailyPlan);
    }
    matrix.push(row);
  }

  // 5. ×›×ª×™×‘×”
  if (matrix.length > 0) {
    let range = outputSheet.getRangeByIndexes(1, 0, matrix.length, 8);
    range.setValues(matrix);
    formatOutputTable(outputSheet, range);
  }

  outputSheet.activate();
}

/**
 * ×× ×•×¢ ×™×™×¦×•×¨ ×œ×•"×– ×™×•××™
 */
function generateDayPlan(ctrl: Controller, dayIdx: number, stations: Station[], tracker: GlobalWeeklyTracker): string {
  let startStr: string = ctrl.start;
  let endStr: string = ctrl.end;
  
  if (dayIdx === 5) { startStr = "06:00"; endStr = "14:30"; }
  if (dayIdx === 6) { startStr = "19:00"; endStr = "24:00"; }

  let currentMin: number = timeToMin(startStr);
  let endMin: number = timeToMin(endStr);
  let planText: string = "";
  const dayKey: string = `d${dayIdx}_`;

  while (currentMin < endMin - 15) {
    let timeLeft: number = endMin - currentMin;
    let selectedTask: Task | null = null;

    // ××™×œ×•×¥ ×§×¨×•× ×•×ª
    if (timeLeft >= 65) {
        const isMorning = currentMin >= 360 && currentMin < 840;
        const isEvening = currentMin >= 840 && currentMin < 1320;
        
        if (isMorning || isEvening) {
            const hubs = stations.filter(s => s.isHub);
            const hub = hubs[Math.floor(Math.random() * hubs.length)];
            selectedTask = { name: "âš™ï¸ ×‘×§×¨×ª ×§×¨×•× ×•×ª", duration: 65, category: "KARON", detail: hub.name };
        }
    }

    // ××™×œ×•×¥ ×ª×—× ×•×ª
    if (!selectedTask) {
        const availableStation = stations.find(s => !tracker.stations.has(dayKey + s.name));
        if (availableStation && availableStation.stayMin <= timeLeft) {
            selectedTask = { 
                name: availableStation.type === "UG" ? "ğŸš‰ ×‘×§×¨×ª ×ª×ª\"×§" : "ğŸš‰ ×‘×§×¨×ª AG", 
                duration: availableStation.stayMin, 
                category: "STATION", 
                detail: availableStation.name 
            };
            tracker.stations.add(dayKey + availableStation.name);
        }
    }

    // ××•× ×‘×•×¨×“ / ××¡×™×œ×”
    if (!selectedTask) {
        if (timeLeft >= 80 && Math.random() > 0.5) {
            selectedTask = { name: "ğŸš† ××•× ×‘×•×¨×“ R1", duration: 80, category: "ONBOARD", detail: "××¡×œ×•×œ ××œ×" };
        } else if (timeLeft >= 30) {
            selectedTask = { name: "ğŸ›¤ï¸ × ×™×§×™×•×Ÿ ××¡×™×œ×”", duration: 30, category: "TRACK", detail: "××§×˜×¢" };
        } else if (timeLeft >= 15) {
            selectedTask = { name: "ğŸ“ ×©×™×¨×•×ª ×œ× ×•×¡×¢", duration: 15, category: "SERVICE", detail: "××•×§×“" };
        }
    }

    if (!selectedTask) break;

    planText += `[${minToTime(currentMin)}] ${selectedTask.name} (${selectedTask.detail})\n`;
    planText += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
    currentMin += selectedTask.duration;
  }
  return planText;
}

// --- ×‘×¡×™×¡ × ×ª×•× ×™× ---

function getStationsDB(): Station[] {
  return [
    {id:1, name:"×”×§×•×××™×•×ª", type:"AG", controlMin:20, stayMin:30, isHub:true},
    {id:2, name:"×”×¢××œ", type:"AG", controlMin:20, stayMin:30, isHub:false},
    {id:16, name:"××œ×™×¤×œ×˜", type:"AG", controlMin:40, stayMin:60, isHub:true},
    {id:17, name:"××œ× ×‘×™", type:"UG", controlMin:40, stayMin:60, isHub:false},
    {id:18, name:"×§×¨×œ×™×‘×š", type:"UG", controlMin:40, stayMin:60, isHub:false},
    {id:19, name:"×™×”×•×“×™×ª", type:"UG", controlMin:40, stayMin:60, isHub:false},
    {id:20, name:"×©××•×œ ×”××œ×š", type:"UG", controlMin:40, stayMin:60, isHub:false},
    {id:21, name:"××¨×œ×•×–×•×¨×•×‘", type:"UG", controlMin:40, stayMin:60, isHub:false},
    {id:22, name:"××‘× ×”×œ×œ", type:"UG", controlMin:40, stayMin:60, isHub:false},
    {id:23, name:"×‘×™××œ×™×§", type:"UG", controlMin:40, stayMin:60, isHub:false},
    {id:24, name:"×‘×Ÿ ×’×•×¨×™×•×Ÿ", type:"UG", controlMin:40, stayMin:60, isHub:false},
    {id:25, name:"××”×¨×•× ×•×‘×™×¥", type:"UG", controlMin:40, stayMin:60, isHub:false},
    {id:26, name:"×× ×”××•×©×‘×•×ª", type:"UG", controlMin:40, stayMin:60, isHub:false},
    {id:27, name:"×§×¨×™×™×ª ××¨×™×”", type:"AG", controlMin:20, stayMin:30, isHub:true},
    {id:30, name:"×‘×œ×™× ×¡×•×Ÿ", type:"AG", controlMin:40, stayMin:50, isHub:false},
    {id:34, name:"×ª\"× ×¤\"×ª", type:"AG", controlMin:20, stayMin:30, isHub:true}
  ];
}

// --- ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×•×§×¨×™××” ---

function readControllers(workbook: ExcelScript.Workbook): Controller[] {
  let table = workbook.getTable("×”×’×“×¨×•×ª_×‘×§×¨×™×_TBL");
  if (!table) {
      return [
        {name: "××•×¨×™ ××™×™×–×œ×¨", start: "07:00", end: "16:00"},
        {name: "××™× ×” ×˜×™××•×¤×™×™×‘", start: "14:00", end: "23:00"}
      ];
  }
  let vals = table.getRangeBetweenHeaderAndTotal().getValues() as (string | number | boolean)[][];
  return vals.map(r => ({ 
      name: String(r[0]), 
      start: convertTime(r[1]), 
      end: convertTime(r[2]) 
  }));
}

function setupReferenceData(workbook: ExcelScript.Workbook) {
    if (!workbook.getWorksheet("×”×’×“×¨×•×ª_×‘×§×¨×™×")) {
        let sheet = workbook.addWorksheet("×”×’×“×¨×•×ª_×‘×§×¨×™×");
        let data: (string | number)[][] = [
            ["×©×", "×”×ª×—×œ×”", "×¡×™×•×"],
            ["××•×¨×™ ××™×™×–×œ×¨", "07:00", "16:00"], ["××™× ×” ×˜×™××•×¤×™×™×‘", "07:00", "16:00"],
            ["×“×•×“ ×¡×™×™×’", "07:00", "16:00"], ["×‘×ª×™×” ××‘×™×”", "09:00", "18:00"],
            ["×”×¨×¦×œ ×©×’×‘", "14:00", "23:00"], ["×™×•× ×™ ×™×•×¡×£", "14:00", "23:00"]
        ];
        sheet.getRangeByIndexes(0,0,data.length, 3).setValues(data);
        sheet.addTable(sheet.getUsedRange(), true).setName("×”×’×“×¨×•×ª_×‘×§×¨×™×_TBL");
    }
}

function timeToMin(t: string): number {
    if (!t || t.indexOf(":") === -1) return 0;
    // ×ª×™×§×•×Ÿ ×©×•×¨×” 224: ×©×™××•×© ×‘-Arrow Function
    let parts = t.split(":").map(v => Number(v));
    return parts[0] * 60 + parts[1];
}

function minToTime(m: number): string {
    return `${Math.floor(m/60).toString().padStart(2,'0')}:${(m%60).toString().padStart(2,'0')}`;
}

function convertTime(v: string | number | boolean): string {
    if (typeof v === 'number') {
        return minToTime(Math.round(v * 24 * 60));
    }
    return String(v);
}

function formatHeader(r: ExcelScript.Range) {
    let format = r.getFormat();
    format.getFill().setColor("#0f172a");
    format.getFont().setColor("white");
    format.getFont().setBold(true);
    format.setHorizontalAlignment(ExcelScript.HorizontalAlignment.center);
}

function formatOutputTable(s: ExcelScript.Worksheet, r: ExcelScript.Range) {
    let format = r.getFormat();
    format.setWrapText(true);
    format.setVerticalAlignment(ExcelScript.VerticalAlignment.top);
    format.getFont().setSize(8);
    s.getRange("B:H").getFormat().setColumnWidth(165);
    s.getRange("A:A").getFormat().setColumnWidth(100);
}
