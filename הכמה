/**
 * RedLine Master Scheduler V15.0
 * ××›×™×¤×ª ×—×•×§×™× ××œ××”: ×§×¨×•× ×•×ª, ××¡×™×œ×•×ª, ×ª×—× ×•×ª (34), ××•× ×‘×•×¨×“ ×•×©×™×¨×•×ª.
 */

interface Station {
  id: number;
  name: string;
  type: string; // AG / UG
  controlMin: number; // ×–××Ÿ ×‘×“×™×§×”
  stayMin: number; // ×–××Ÿ ×©×”×™×™×”/××¢×‘×¨
  isHub: boolean; // ×ª×—× ×ª ×§×¦×” ×œ×§×¨×•× ×•×ª
}

interface Task {
  name: string;
  category: string;
  duration: number;
  detail: string;
}

interface Controller {
  name: string;
  start: string;
  end: string;
}

function main(workbook: ExcelScript.Workbook) {
  // 1. ×”×§××ª ×’×™×œ×™×•× ×•×ª ×¢×–×¨ (×× ×—×¡×¨×™×)
  setupReferenceData(workbook);

  // 2. ×§×¨×™××ª × ×ª×•× ×™×
  const stations = getStationsDB();
  const controllers = readControllers(workbook);
  const kpiDone = readCurrentMonthStats(workbook);

  // 3. ×”×›× ×ª ×’×™×œ×™×•×Ÿ ×¤×œ×˜
  let outputSheet = workbook.getWorksheet("×¡×™×“×•×¨_×¢×‘×•×“×”_×©×‘×•×¢×™");
  if (!outputSheet) outputSheet = workbook.addWorksheet("×¡×™×“×•×¨_×¢×‘×•×“×”_×©×‘×•×¢×™");
  outputSheet.getUsedRange()?.clear();

  const days = ["×¨××©×•×Ÿ", "×©× ×™", "×©×œ×™×©×™", "×¨×‘×™×¢×™", "×—××™×©×™", "×©×™×©×™", "××•×¦\"×©"];
  outputSheet.getRange("A1:H1").setValues([["×‘×§×¨", ...days]]);
  formatHeader(outputSheet.getRange("A1:H1"));

  // 4. ×× ×•×¢ ×©×™×‘×•×¥ ×©×‘×•×¢×™
  let matrix: string[][] = [];
  
  // × ×™×”×•×œ ××©×™××•×ª ×©×‘×•×¦×¢×• ×”×©×‘×•×¢ ×’×œ×•×‘×œ×™×ª
  let globalWeeklyTracker = {
    stations: new Set<string>(), // ×× ×™×¢×ª ×›×¤×™×œ×•×ª ×™×•××™×ª
    karonDailyHours: 0,
    trackCount: 0
  };

  for (let ctrl of controllers) {
    let row: string[] = [ctrl.name];
    
    for (let dIdx = 0; dIdx < 7; dIdx++) {
      // ×‘×›×œ ×™×•× ×—×“×© ×œ×‘×§×¨, × ××¤×¡ ××ª ×¨×©×™××ª ×”×ª×—× ×•×ª ×©×”×•× ×‘×™×§×¨ ×‘×”×Ÿ (×× ×¨×•×¦×™× ×œ×× ×•×¢ ×›×¤×™×œ×•×ª ××™×©×™×ª)
      // ××‘×œ ×”×“×¨×™×©×” ×”×™× "×œ× ×™×•×ª×¨ ×-1 ×‘×™×•× ×‘×›×œ ×ª×—× ×”" ×’×œ×•×‘×œ×™×ª.
      // ×œ×›×Ÿ × × ×”×œ ××¢×§×‘ ×™×•××™ ×’×œ×•×‘×œ×™.
      
      let dailyPlan = generateDayPlan(ctrl, dIdx, stations, globalWeeklyTracker);
      row.push(dailyPlan);
    }
    matrix.push(row);
  }

  // 5. ×›×ª×™×‘×” ×•×¢×™×¦×•×‘
  if (matrix.length > 0) {
    let range = outputSheet.getRangeByIndexes(1, 0, matrix.length, 8);
    range.setValues(matrix);
    formatOutputTable(outputSheet, range);
  }

  outputSheet.activate();
}

/**
 * ×× ×•×¢ ×™×™×¦×•×¨ ×œ×•"×– ×™×•××™ ×œ×¤×™ ×›×œ ×”××™×œ×•×¦×™×
 */
function generateDayPlan(ctrl: Controller, dayIdx: number, stations: Station[], tracker: any): string {
  let startStr = ctrl.start;
  let endStr = ctrl.end;
  
  // ×—×•×§×™ ×¡×•×¤"×©
  if (dayIdx === 5) { startStr = "06:00"; endStr = "14:30"; }
  if (dayIdx === 6) { startStr = "19:00"; endStr = "24:00"; }

  let currentMin = timeToMin(startStr);
  let endMin = timeToMin(endStr);
  let planText = "";
  
  // ××¢×§×‘ ×ª×—× ×•×ª ×©×©×•×‘×¦×• ×›×‘×¨ ×”×™×•× ×‘×¡×™×“×•×¨ ×”×›×œ×œ×™ (×œ×•×’×™×§×” ×¤×©×•×˜×” ×‘×ª×•×š ×”×œ×•×œ××”)
  const dayKey = `d${dayIdx}_`;

  while (currentMin < endMin - 15) {
    let timeLeft = endMin - currentMin;
    let selectedTask: Task | null = null;

    // ××™×œ×•×¥ ×': ×‘×§×¨×ª ×§×¨×•× ×•×ª (×©×¢×ª×™×™× ×‘×‘×•×§×¨ / ×©×¢×ª×™×™× ×‘×¢×¨×‘)
    if (timeLeft >= 65) {
        const isMorning = currentMin >= 360 && currentMin < 840; // 06:00-14:00
        const isEvening = currentMin >= 840 && currentMin < 1320; // 14:00-22:00
        
        // ×× ×”×‘×§×¨ ×‘×˜×•×•×— ×©×¢×•×ª ×§×¨×•× ×•×ª, × × ×¡×” ×œ×©×‘×¥ ×§×¨×•× ×•×ª (65 ×“×§')
        if (isMorning || isEvening) {
            const hub = stations.filter(s => s.isHub)[Math.floor(Math.random() * 4)];
            selectedTask = { name: "âš™ï¸ ×‘×§×¨×ª ×§×¨×•× ×•×ª", duration: 65, category: "KARON", detail: hub.name };
        }
    }

    // ××™×œ×•×¥ ×‘': ×‘×§×¨×ª ×ª×—× ×•×ª (×× ×œ× ×©×•×‘×¥ ×§×¨×•× ×•×ª)
    if (!selectedTask) {
        // ××—×¤×©×™× ×ª×—× ×” ×©×˜×¨× × ×‘×“×§×” ×”×™×•× (tracker)
        const availableStation = stations.find(s => !tracker.stations.has(dayKey + s.name));
        if (availableStation && availableStation.stayMin <= timeLeft) {
            selectedTask = { 
                name: availableStation.type === "UG" ? "ğŸš‰ ×‘×§×¨×ª ×ª×ª\"×§" : "ğŸš‰ ×‘×§×¨×ª AG", 
                duration: availableStation.stayMin, 
                category: "STATION", 
                detail: availableStation.name 
            };
            tracker.stations.add(dayKey + availableStation.name);
        }
    }

    // ××™×œ×•×¥ ×’': ××•× ×‘×•×¨×“ / ××¡×™×œ×” / ×©×™×¨×•×ª (×œ××™×œ×•×™ ×–××Ÿ)
    if (!selectedTask) {
        if (timeLeft >= 80 && Math.random() > 0.5) {
            selectedTask = { name: "ğŸš† ××•× ×‘×•×¨×“ R1", duration: 80, category: "ONBOARD", detail: "××¡×œ×•×œ ××œ×" };
        } else if (timeLeft >= 30) {
            selectedTask = { name: "ğŸ›¤ï¸ × ×™×§×™×•×Ÿ ××¡×™×œ×”", duration: 30, category: "TRACK", detail: "××§×˜×¢ ××§×¨××™" };
        } else if (timeLeft >= 15) {
            selectedTask = { name: "ğŸ“ ×©×™×¨×•×ª ×œ× ×•×¡×¢", duration: 15, category: "SERVICE", detail: "××•×§×“/××¨×›×–" };
        }
    }

    if (!selectedTask) break;

    planText += `[${minToTime(currentMin)}] ${selectedTask.name} (${selectedTask.detail})\n`;
    planText += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
    currentMin += selectedTask.duration;
  }

  return planText;
}

// --- × ×ª×•× ×™ ×‘×¡×™×¡ (34 ×”×ª×—× ×•×ª ×”××“×•×™×§×•×ª) ---

function getStationsDB(): Station[] {
  return [
    {id:1, name:"×”×§×•×××™×•×ª", type:"AG", controlMin:20, stayMin:30, isHub:true},
    {id:2, name:"×”×¢××œ", type:"AG", controlMin:20, stayMin:30, isHub:false},
    {id:3, name:"×›\"×˜ ×‘× ×•×‘××‘×¨", type:"AG", controlMin:20, stayMin:30, isHub:false},
    {id:4, name:"×™×•×¡×¤×˜×œ", type:"AG", controlMin:20, stayMin:30, isHub:false},
    {id:5, name:"×‘× ×™××™×Ÿ", type:"AG", controlMin:20, stayMin:30, isHub:false},
    {id:6, name:"×‘×œ×¤×•×¨", type:"AG", controlMin:20, stayMin:30, isHub:false},
    {id:7, name:"×–'×‘×•×˜×™× ×¡×§×™", type:"AG", controlMin:20, stayMin:30, isHub:false},
    {id:8, name:"×¨×•×˜×©×™×œ×“", type:"AG", controlMin:20, stayMin:30, isHub:false},
    {id:9, name:"×”×¢×¦×××•×ª", type:"AG", controlMin:20, stayMin:30, isHub:false},
    {id:10, name:"××—×¨×•×–×ª", type:"AG", controlMin:20, stayMin:30, isHub:false},
    {id:11, name:"×”×‘×¢×©\"×˜", type:"AG", controlMin:20, stayMin:30, isHub:false},
    {id:12, name:"××™×¡×§×•×‘", type:"AG", controlMin:20, stayMin:30, isHub:false},
    {id:13, name:"××¨×œ×™×š", type:"AG", controlMin:20, stayMin:30, isHub:false},
    {id:14, name:"×‘×œ×•××¤×™×œ×“", type:"AG", controlMin:20, stayMin:30, isHub:false},
    {id:15, name:"×©×œ××”", type:"AG", controlMin:20, stayMin:30, isHub:false},
    {id:16, name:"××œ×™×¤×œ×˜", type:"AG", controlMin:40, stayMin:60, isHub:true},
    {id:17, name:"××œ× ×‘×™", type:"UG", controlMin:40, stayMin:60, isHub:false},
    {id:18, name:"×§×¨×œ×™×‘×š", type:"UG", controlMin:40, stayMin:60, isHub:false},
    {id:19, name:"×™×”×•×“×™×ª", type:"UG", controlMin:40, stayMin:60, isHub:false},
    {id:20, name:"×©××•×œ ×”××œ×š", type:"UG", controlMin:40, stayMin:60, isHub:false},
    {id:21, name:"××¨×œ×•×–×•×¨×•×‘", type:"UG", controlMin:40, stayMin:60, isHub:false},
    {id:22, name:"××‘× ×”×œ×œ", type:"UG", controlMin:40, stayMin:60, isHub:false},
    {id:23, name:"×‘×™××œ×™×§", type:"UG", controlMin:40, stayMin:60, isHub:false},
    {id:24, name:"×‘×Ÿ ×’×•×¨×™×•×Ÿ", type:"UG", controlMin:40, stayMin:60, isHub:false},
    {id:25, name:"××”×¨×•× ×•×‘×™×¥", type:"UG", controlMin:40, stayMin:60, isHub:false},
    {id:26, name:"×× ×”××•×©×‘×•×ª", type:"UG", controlMin:40, stayMin:60, isHub:false},
    {id:27, name:"×§×¨×™×™×ª ××¨×™×”", type:"AG", controlMin:20, stayMin:30, isHub:true},
    {id:28, name:"×©× ×§×¨", type:"AG", controlMin:20, stayMin:30, isHub:false},
    {id:29, name:"×©×—×", type:"AG", controlMin:20, stayMin:30, isHub:false},
    {id:30, name:"×‘×œ×™× ×¡×•×Ÿ", type:"AG", controlMin:40, stayMin:50, isHub:false},
    {id:31, name:"×“× ×§× ×¨", type:"AG", controlMin:20, stayMin:30, isHub:false},
    {id:32, name:"×§×¨×•×œ", type:"AG", controlMin:20, stayMin:30, isHub:false},
    {id:33, name:"×¤×™× ×¡×§×¨", type:"AG", controlMin:20, stayMin:30, isHub:false},
    {id:34, name:"×ª\"× ×¤\"×ª", type:"AG", controlMin:20, stayMin:30, isHub:true}
  ];
}

// --- ×¤×•× ×§×¦×™×•×ª ×ª×©×ª×™×ª ×•×§×¨×™××” ---

function readControllers(workbook: ExcelScript.Workbook): Controller[] {
  let table = workbook.getTable("×”×’×“×¨×•×ª_×‘×§×¨×™×_TBL");
  if (!table) return getControllerDefaults();
  let vals = table.getRangeBetweenHeaderAndTotal().getValues() as (string | number)[][];
  return vals.map(r => ({ name: r[0] as string, start: String(r[1]), end: String(r[2]) }));
}

function readCurrentMonthStats(workbook: ExcelScript.Workbook) {
    // ×›××Ÿ ××¤×©×¨ ×œ×§×¨×•× ××”×’×™×œ×™×•×Ÿ ×”×—×•×“×©×™ - ×œ×¦×•×¨×š ×”×¡×™××•×œ×¦×™×” × × ×™×— ×”×ª×—×œ×” × ×§×™×™×”
    return { stations: 0, onboard: 0 };
}

function setupReferenceData(workbook: ExcelScript.Workbook) {
    if (!workbook.getWorksheet("×”×’×“×¨×•×ª_×‘×§×¨×™×")) {
        let sheet = workbook.addWorksheet("×”×’×“×¨×•×ª_×‘×§×¨×™×");
        let data = [
            ["×©×", "×”×ª×—×œ×”", "×¡×™×•×"],
            ["××•×¨×™ ××™×™×–×œ×¨", "07:00", "16:00"], ["××™× ×” ×˜×™××•×¤×™×™×‘", "07:00", "16:00"],
            ["×“×•×“ ×¡×™×™×’", "07:00", "16:00"], ["×‘×ª×™×” ××‘×™×”", "09:00", "18:00"],
            ["×”×¨×¦×œ ×©×’×‘", "14:00", "23:00"], ["×™×•× ×™ ×™×•×¡×£", "14:00", "23:00"],
            ["××‘×¨×”× ×’×‘×¨×™×œ×‘×™×¥", "08:00", "17:00"], ["×¨×•×Ÿ ×˜×•×‘", "12:00", "21:00"]
        ];
        sheet.getRangeByIndexes(0,0,data.length, 3).setValues(data);
        sheet.addTable(sheet.getUsedRange(), true).setName("×”×’×“×¨×•×ª_×‘×§×¨×™×_TBL");
    }
}

// --- ×›×œ×™ ×¢×–×¨ ---

function timeToMin(t: string): number {
    if (!t || t.indexOf(":") === -1) return 0;
    let [h, m] = t.split(":").map(Number);
    return h * 60 + m;
}

function minToTime(m: number): string {
    return `${Math.floor(m/60).toString().padStart(2,'0')}:${(m%60).toString().padStart(2,'0')}`;
}

function formatHeader(r: ExcelScript.Range) {
    r.getFormat().getFill().setColor("#0f172a");
    r.getFormat().getFont().setColor("white");
    r.getFormat().getFont().setBold(true);
    r.getFormat().setHorizontalAlignment(ExcelScript.HorizontalAlignment.center);
}

function formatOutputTable(s: ExcelScript.Worksheet, r: ExcelScript.Range) {
    r.getFormat().setWrapText(true);
    r.getFormat().setVerticalAlignment(ExcelScript.VerticalAlignment.top);
    r.getFormat().getFont().setSize(8);
    s.getRange("B:H").getFormat().setColumnWidth(165);
    s.getRange("A:A").getFormat().setColumnWidth(100);
}

function getControllerDefaults(): Controller[] {
    return [
        {name: "××•×¨×™ ××™×™×–×œ×¨", start: "07:00", end: "16:00"},
        {name: "××™× ×” ×˜×™××•×¤×™×™×‘", start: "14:00", end: "23:00"}
    ];
}
